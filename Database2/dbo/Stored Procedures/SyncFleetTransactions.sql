CREATE PROCEDURE [dbo].[SyncFleetTransactions]

@TransactionId [bigint] null=0,
@FleetNumber nvarchar(max),
@UserId int null=0,
@PreviousTransactionStatusId [bigint] null=0,
@Message nvarchar(max) OUTPUT

AS 

BEGIN

SET NOCOUNT ON;

BEGIN TRAN

Declare @PreviousFleetNumber nvarchar(max)
Declare @ParentTransactionId [bigint]
Declare @FirstFleetLinkedTransactionId [bigint]
Declare @LinkedTransactionsCount [bigint]
Declare @ErrorCount int
Declare @BranchId [bigint]
Declare @ActiveTranasctionStatusId bigint
Declare @IsParentTranasaction bit
Declare @IsClosedTransactionMadeActive bit

set @IsParentTranasaction=0
set @PreviousFleetNumber = ''
set @ParentTransactionId = 0
set @FirstFleetLinkedTransactionId = 0
set @LinkedTransactionsCount=0
set @ErrorCount = 0
set @BranchId=0
set @ActiveTranasctionStatusId=0
set @IsClosedTransactionMadeActive=0
-- GET FLEET Number
set @ActiveTranasctionStatusId= (SELECT [Id] FROM [StaticValue] where [StaticCategoryId]=(Select [Id] FROM [dbo].[StaticCategory] where [Name]='TransactionStatus' and [IsActive]=1)
 AND [IsActive]=1 AND [EnumName]='ACTIVE')
set @PreviousFleetNumber =(Select [FleetNumber] FROM [Transaction] where [Id]=@TransactionId)
set @BranchId=(Select [BranchId] FROM [Transaction] where [Id]=@TransactionId)
set @LinkedTransactionsCount =(Select count(1) FROM [Transaction] where [FleetNumber]=@FleetNumber AND [BranchId]=@BranchId AND [isActive]=1 AND [Id]<>@TransactionId)
set @ParentTransactionId = (Select TOP 1 [Id] FROM [Transaction] where [FleetNumber]=@FleetNumber AND [BranchId]=@BranchId AND [isActive]=1 AND [ParentTransactionId] is NULL 
AND ([TransactionStatusId]=@ActiveTranasctionStatusId OR [TransactionStatusId] IS NULL) ORDER BY 1 DESC)

IF (@ParentTransactionId is NULL) OR (@ParentTransactionId = @TransactionId)
BEGIN	
	set @IsParentTranasaction=1
END

IF (@PreviousTransactionStatusId is NULL) OR (@PreviousTransactionStatusId = @ActiveTranasctionStatusId)
BEGIN	
	set @IsClosedTransactionMadeActive=0
END
ELSE
BEGIN	
	set @IsClosedTransactionMadeActive=1
END



--Select @LinkedTransactionsCount
--PRINT('@LinkedTransactionsCount')

IF @LinkedTransactionsCount > 0
Begin 
   
   -------------------- Transaction Details Starts ----------------------------

   --GET THE VALUES FROM TRANSACTION TO SYNC FROM
	Declare		@TransactionTypeId [bigint] 
	Declare		@TransactionStatusId [bigint] 
	Declare		@TransactionStatusNotes [nvarchar](4000) 
	Declare		@FinanceStatusId [bigint] 
	Declare		@FinanceStatusNotes [nvarchar](4000) 	
	Declare	    @BusinessManagerId [bigint] 
	Declare		@SalesPersonId [bigint] 
	Declare		@IsDealSighted bit  
	Declare		@IsPreArrangedFinance bit
	Declare		@IsCashTransaction bit
	Declare		@FinanceTermId [bigint] 
	Declare		@FinanceType [bigint] 
	Declare		@PreferredInterestRate [decimal](18, 2) 
	Declare		@PrimeInterestRate [decimal](18, 2) 
	Declare		@BusinessSegment [bigint]  
	Declare		@PreferredCallTime [bigint] 
	Declare		@IsBlockAutomaticUpdate bit	
	Declare		@Scheme [nvarchar](max) 

	SET		@TransactionTypeId = (Select TransactionTypeId FROM [Transaction] where [Id]=@TransactionId)
	SET		@TransactionStatusId = (Select TransactionStatusId FROM [Transaction] where [Id]=@TransactionId)
	SET		@TransactionStatusNotes = (Select TransactionStatusNotes FROM [Transaction] where [Id]=@TransactionId)
	SET		@FinanceStatusId = (Select FinanceStatusId FROM [Transaction] where [Id]=@TransactionId)
	SET		@FinanceStatusNotes = (Select FinanceStatusNotes FROM [Transaction] where [Id]=@TransactionId)	
	SET	    @BusinessManagerId = (Select BusinessManagerId FROM [Transaction] where [Id]=@TransactionId)
	SET		@SalesPersonId = (Select SalesPersonId FROM [Transaction] where [Id]=@TransactionId)
	SET		@IsDealSighted = (Select IsDealSighted FROM [Transaction] where [Id]=@TransactionId)
	SET		@IsPreArrangedFinance = (Select IsPreArrangedFinance FROM [Transaction] where [Id]=@TransactionId)
	SET		@IsCashTransaction = (Select IsCashTransaction FROM [Transaction] where [Id]=@TransactionId)
	SET		@FinanceTermId= (Select FinanceTermId FROM [Transaction] where [Id]=@TransactionId)
	SET		@FinanceType = (Select FinanceType FROM [Transaction] where [Id]=@TransactionId)
	SET		@PreferredInterestRate = (Select PreferredInterestRate FROM [Transaction] where [Id]=@TransactionId)
	SET		@PrimeInterestRate = (Select PrimeInterestRate FROM [Transaction] where [Id]=@TransactionId)
	SET		@BusinessSegment = (Select BusinessSegment FROM [Transaction] where [Id]=@TransactionId)
	SET		@PreferredCallTime = (Select PreferredCallTime FROM [Transaction] where [Id]=@TransactionId)
	SET		@IsBlockAutomaticUpdate = (Select IsBlockAutomaticUpdate FROM [Transaction] where [Id]=@TransactionId)
	SET		@Scheme = (Select Scheme FROM [Transaction] where [Id]=@TransactionId)

	
	--INSERT UPDATED VALUES INTO LINKED TRANSACTIONS TEMP TABLE 
	IF OBJECT_ID('tempdb..#temp_table_LinkedTransactions') IS NOT NULL
    DROP TABLE #temp_table_LinkedTransactions

	IF OBJECT_ID('tempdb..#temp_table_LinkedTransactionsClosed') IS NOT NULL
    DROP TABLE #temp_table_LinkedTransactionsClosed

	IF OBJECT_ID('tempdb..#temp_table_LinkedTransactionsActive') IS NOT NULL
    DROP TABLE #temp_table_LinkedTransactionsActive
			
	Select  [Id] as [Id]
			,@TransactionTypeId as [TransactionTypeId]
			,@TransactionStatusNotes as TransactionStatusNotes
			,@FinanceStatusId as FinanceStatusId
			,@FinanceStatusNotes as FinanceStatusNotes	 		
			,@BusinessManagerId as BusinessManagerId
			,@SalesPersonId as SalesPersonId
			,@IsDealSighted as IsDealSighted
			,@IsPreArrangedFinance as IsPreArrangedFinance
			,@IsCashTransaction as IsCashTransaction
			,@FinanceTermId as FinanceTermId
			,@FinanceType as FinanceType
			,@PreferredInterestRate as PreferredInterestRate
			,@PrimeInterestRate as PrimeInterestRate
			,@BusinessSegment as BusinessSegment
			,@PreferredCallTime as PreferredCallTime
			,@IsBlockAutomaticUpdate as IsBlockAutomaticUpdate	
			,@Scheme as Scheme
			,[TransactionClientId] as [TransactionClientId]
	  INTO #temp_table_LinkedTransactions
	  FROM [Transaction] LT
	  where [FleetNumber]=@FleetNumber AND [BranchId]=@BranchId AND [isActive]=1 
	  AND [Id]<> @TransactionId  AND [IsIncepted]=0
	  order by [Id] 

	Select  [Id] as [Id]
			,@TransactionTypeId as [TransactionTypeId]
			,@TransactionStatusNotes as TransactionStatusNotes
			,@FinanceStatusId as FinanceStatusId
			,@FinanceStatusNotes as FinanceStatusNotes	 		
			,@BusinessManagerId as BusinessManagerId
			,@SalesPersonId as SalesPersonId
			,@IsDealSighted as IsDealSighted
			,@IsPreArrangedFinance as IsPreArrangedFinance
			,@IsCashTransaction as IsCashTransaction
			,@FinanceTermId as FinanceTermId
			,@FinanceType as FinanceType
			,@PreferredInterestRate as PreferredInterestRate
			,@PrimeInterestRate as PrimeInterestRate
			,@BusinessSegment as BusinessSegment
			,@PreferredCallTime as PreferredCallTime
			,@IsBlockAutomaticUpdate as IsBlockAutomaticUpdate	
			,@Scheme as Scheme
			,[TransactionClientId] as [TransactionClientId]
	  INTO #temp_table_LinkedTransactionsClosed
	  FROM [Transaction] LT
	  where [FleetNumber]=@FleetNumber AND [BranchId]=@BranchId AND [isActive]=1 
	  AND [Id]<> @TransactionId  AND [IsIncepted]=0 
	  AND ([TransactionStatusId] <> @ActiveTranasctionStatusId AND [TransactionStatusId] IS NOT NULL) 
	  order by [Id] 

	Select  [Id] as [Id]
			,@TransactionTypeId as [TransactionTypeId]
			,@TransactionStatusNotes as TransactionStatusNotes
			,@FinanceStatusId as FinanceStatusId
			,@FinanceStatusNotes as FinanceStatusNotes	 		
			,@BusinessManagerId as BusinessManagerId
			,@SalesPersonId as SalesPersonId
			,@IsDealSighted as IsDealSighted
			,@IsPreArrangedFinance as IsPreArrangedFinance
			,@IsCashTransaction as IsCashTransaction
			,@FinanceTermId as FinanceTermId
			,@FinanceType as FinanceType
			,@PreferredInterestRate as PreferredInterestRate
			,@PrimeInterestRate as PrimeInterestRate
			,@BusinessSegment as BusinessSegment
			,@PreferredCallTime as PreferredCallTime
			,@IsBlockAutomaticUpdate as IsBlockAutomaticUpdate	
			,@Scheme as Scheme
			,[TransactionClientId] as [TransactionClientId]
	  INTO #temp_table_LinkedTransactionsActive
	  FROM [Transaction] LT
	  where [FleetNumber]=@FleetNumber AND [BranchId]=@BranchId AND [isActive]=1 
	  AND [Id]<> @TransactionId  AND [IsIncepted]=0 
	  AND ([TransactionStatusId] = @ActiveTranasctionStatusId AND [TransactionStatusId] IS NULL) 
	  order by [Id] 
	  	
     -- BULK UPDATE TRANSACTION TABLE FROM LINKED TRANSACTIONs OF TEMP TABLE
	 --Select * from #temp_table_LinkedTransactions	 
	 
	 UPDATE LT 
	 SET LT.[TransactionTypeId]=T.[TransactionTypeId]
        ,LT.[TransactionStatusNotes]=T.[TransactionStatusNotes]
      --,LT.[FinanceStatusId]=T.[FinanceStatusId]
      ,LT.[FinanceStatusNotes]=T.[FinanceStatusNotes]
	  ,LT.[BusinessManagerId]=T.[BusinessManagerId]      
      ,LT.[SalesPersonId]=T.[SalesPersonId]
      ,LT.[IsDealSighted]=T.[IsDealSighted]   
	  ,LT.[IsPreArrangedFinance]=T.[IsPreArrangedFinance]
	  ,LT.[IsCashTransaction]=T.[IsCashTransaction]
	  ,LT.[FinanceTermId]=T.[FinanceTermId]	  
      ,LT.FinanceType=T.FinanceType      
      ,LT.[PreferredInterestRate]=T.[PreferredInterestRate]
	  ,LT.PrimeInterestRate=T.PrimeInterestRate
      ,LT.BusinessSegment=T.BusinessSegment
      ,LT.PreferredCallTime=T.PreferredCallTime
      ,LT.IsBlockAutomaticUpdate=T.IsBlockAutomaticUpdate
	  ,LT.Scheme=T.Scheme
	FROM #temp_table_LinkedTransactions AS T
	INNER JOIN [Transaction] LT 
	ON T.[Id] = LT.[Id]
	  
    --CHECK IF CURRENT TRANSACTION CLOSED / ACTIVE
	IF  (@TransactionStatusId is NULL) OR (@TransactionStatusId = @ActiveTranasctionStatusId)
	BEGIN	
		
			IF @IsClosedTransactionMadeActive =1 
			BEGIN
				
				       IF (Select FinanceStatusId FROM [Transaction] where [Id]=@ParentTransactionId) IS NOT NULL AND (Select FinanceStatusId FROM [Transaction] where [Id]=@ParentTransactionId) >0
					   BEGIN 

						   -- FINANCE STATUS FROM ACTIVE PARENT TRANSACTION
						   UPDATE [Transaction] SET 
						   [FinanceStatusId]= (Select FinanceStatusId FROM [Transaction] where [Id]=@ParentTransactionId)
						   where [Id]=@TransactionId

					   END

			END
			ELSE BEGIN
				
				 -- FINANCE STATUS UPDATE FOR ACTIVE TRANSACTION ONLY
				   UPDATE LT  SET 
				   LT.[FinanceStatusId]=T.[FinanceStatusId]
				   FROM #temp_table_LinkedTransactionsActive AS T
				   INNER JOIN [Transaction] LT 
				   ON T.[Id] = LT.[Id]

			END
		  

	END
	ELSE IF @IsParentTranasaction=1  
	BEGIN

		IF @IsClosedTransactionMadeActive = 0 
		BEGIN
			   -- FINANCE STATUS UPDATE IF PARENT TRANSACTION 
			   UPDATE LT  SET 
			   LT.[FinanceStatusId]=T.[FinanceStatusId]
			   FROM #temp_table_LinkedTransactions AS T
			   INNER JOIN [Transaction] LT 
			   ON T.[Id] = LT.[Id]

		END		

	END


	  --print('test point 5')   
	  --Select * FROM [Transaction] where [FleetNumber]=@FleetNumber AND [BranchId]=@BranchId
	   
	/*-------------------- Transaction Details Ends ----------------------------*/


	/*-------------------- Transaction Client Starts ----------------------------*/

    --GET THE VALUES FROM TRANSACTION CLIENT TO SYNC FROM
	
	Declare	@TransactionClientIdToSync [bigint] 
	SET @TransactionClientIdToSync = (Select [TransactionClientId] FROM [Transaction] where [Id]=@TransactionId)
		
	--INSERT UPDATED VALUES INTO LINKED TRANSACTIONS TEMP TABLE 
	IF OBJECT_ID('tempdb..#temp_table_LinkedTransactionClient') IS NOT NULL
    DROP TABLE #temp_table_LinkedTransactionClients
			
	Select  
		P.[Id] 
	  ,TC.[TitleId]
      ,TC.[FirstName]
      ,TC.[MiddleName]
      ,TC.[LastName]
      ,TC.[Initials]
      ,TC.[DateofBirth]
      ,TC.[PlaceOfBirth]
      ,TC.[Nationality]
      ,TC.[NoofDependents]
      ,TC.[MaritalStatusId]
      ,TC.[MarriageDate]
      ,TC.[GenderId]
      ,TC.[MothersMaidenName]
      ,TC.[UAEResidentSince]
      ,TC.[IDTypeId]
      ,TC.[IDNumber]
      ,TC.[PassportNo]
      ,TC.[PassportIssueDate]
      ,TC.[PassportExpiryDate]
      ,TC.[PassportIssuePlace]
      ,TC.[VisaNo]
      ,TC.[VisaIssueDate]
      ,TC.[VisaExpiryDate]
      ,TC.[VisaIssuePlace]
      ,TC.[EmiratesIdNo]
      ,TC.[EmiratesIdIssueDate]
      ,TC.[EmiratesIdExpiryDate]
      ,TC.[EmiratesIdIssuePlace]
      ,TC.[DriversLicenceNo]
      ,TC.[DriversLicenceIssueDate]
      ,TC.[DriversLicenceExpiryDate]
      ,TC.[DriversLicenceIssuePlace]
      ,TC.[UAEDrivingLicenceNo]
      ,TC.[PreferredName]
      ,TC.[Mobile]
      ,TC.[AlternativeMobile]
      ,TC.[HomePhoneCode]
      ,TC.[HomePhoneNumber]
      ,TC.[WorkPhoneCode]
      ,TC.[WorkPhoneNumber]
      ,TC.[FaxCode]
      ,TC.[FaxNumber]
      ,TC.[ContactNumberInHomeCountry]
      ,TC.[EmailAddress]
      ,TC.[IsSMSAlertRequired]
      ,TC.[PreferedMailingAddress]
      ,TC.[NumberForSMSAlert]
      ,TC.[PhyAddBuildingName]
      ,TC.[PhyAddFlatNo]
      ,TC.[PhyAddUnitNo]
      ,TC.[PhyAddNearestLandmark]
      ,TC.[PhyAddArea]
      ,TC.[PhyAddStreetName]
      ,TC.[PostAddPOBoxNo]
      ,TC.[PhyAddEmirate]
      ,TC.[PhyAddCity]
      ,TC.[PhyAddState]
      ,TC.[PhyAddCountryId]
      ,TC.[PhyAddZipCode]
      ,TC.[PostAddEmirate]
      ,TC.[ResidentialStatus]
      ,TC.[NoOfYearsAtPesentAddress]
      ,TC.[PostAddCountryId]
      ,TC.[RentPerMonth]
      ,TC.[AddressInHomeCountry]
      ,TC.[HomeCountryId]
      ,TC.[BankingDetailsId]
      ,TC.[CustomerType]
      ,TC.[NameOfKin]
      ,TC.[AddressOfKin]
      ,TC.[ContactOfKin]
      ,TC.[CountryId]
      ,TC.[IsActive]
      --,TC.[CreatedDate]
      --,TC.[ModifiedDate]
      --,TC.[CreatedBy]
      --,TC.[ModifiedBy]
      ,TC.[IsGuarantorApplication]
      ,TC.[RegularDriver]
      ,TC.[ConditionsResidentPermit]
      ,TC.[LanguageId]
      ,TC.[MarrageTypeId]
      ,TC.[SpousesName]
      ,TC.[SpousesBirthDate]
      ,TC.[PhyAddSurburb]
      ,TC.[PhyAddTown]
      ,TC.[PostAddSurburb]
      ,TC.[PostAddTown]
      ,TC.[SpecifyResidentialStatus]
      ,TC.[PreviousHomeAddress]
      ,TC.[PreferredCallTime]
      ,TC.[CompanyName]
      ,TC.[ComNatureOfBusiness]
      ,TC.[CompanyStartDate]
      ,TC.[ComTradeLicenceStartDate]
      ,TC.[ComTradeLicenceExpiryDate]
      ,TC.[ComVATNumber]
      ,TC.[ComPhyAddBuildingName]
      ,TC.[ComPhyAddStreetName]
      ,TC.[ComPhyAddEmirate]
      ,TC.[ComPhyAddPostCode]
      ,TC.[ComPhyAddCountryId]
      ,TC.[ComTradingAs]
      ,TC.[ComRegistrationNumber]
      ,TC.[ComNoOfYearsInBusiness]
      ,TC.[ComLandlord]
      ,TC.[ComHoldingCompany]
      ,TC.[ComAssociatedCompany]
      ,TC.[ComSubsidaryCompany]
      ,TC.[ComCompanyRepresentative]
      ,TC.[ComFloorNo]
      ,TC.[ComYearsAtCurrentAddress]
      ,TC.[ComEmirate]
      ,TC.[PhyAdd1]
      ,TC.[PhyAdd2]
      ,TC.[PhyAdd3]
      ,TC.[PostAdd1]
      ,TC.[PostAdd2]
      ,TC.[PostAdd3]
      ,TC.[FinanceStatus]
      ,TC.[FinanceStatusNotes]
      ,TC.[ConditionsOfResidentsPermit]
      ,TC.[BusinessTypeId]
      ,TC.[QualificationId]
      ,TC.[PermitNumber]
      ,TC.[PermitIssueDate]
      ,TC.[PermitExpiryDate]
      ,TC.[IdIssueDate]
      ,TC.[IdExpiryDate]
      ,TC.[SpecifyMaritalStatus]
      ,TC.[EthnicGroup]
      ,TC.[MarketingSource]
      ,TC.[ClaimFreeGroup]
      ,TC.[IsCompanyVATRegistered]
      ,TC.[PhyAdd4]
      ,TC.[PhyAddCode]
      ,TC.[PostAdd4]
      ,TC.[PostAddCode]
      ,TC.[IsCompanyBlackOwned]
      ,TC.[IsCompanyBalanceSheet]
      ,TC.[CompanyFinancialYear]
      ,TC.[CompanyTurnover]
      ,TC.[CompanyTotalAssets]
      ,TC.[NoOfMonthsAtPesentAddress]
      ,TC.[ComPhyAdd1]
      ,TC.[ComPhyAdd2]
      ,TC.[ComPhyAdd3]
      ,TC.[ComPhyAdd4]
      ,TC.[ComPhyAddCode]
      ,TC.[HomeCountryAddress1]
      ,TC.[HomeCountryAddress2]
      ,TC.[HomeCountryAddress3]
      ,TC.[HomeCountryAddress4]
      ,TC.[HomeCountryAddressCode]
      ,TC.[PreferredLanguage]
      ,TC.[TradeLicenseNumber]
      ,TC.[IsSpouseDetailsIncluded]
      ,TC.[ComPhyAddMakaniNumber]
      ,TC.[OfficeBuildingName]
      ,TC.[OfficeStreetName]
      ,TC.[OfficeEmirate]
      ,TC.[OfficeCountry]
      ,TC.[OfficeNearestLandmark]
      ,TC.[OfficeMakaniNumber]
      ,TC.[ComNumberofFleetVehicles]
      ,TC.[ComNumberofMortgagedVehicles]
      ,TC.[IsClientClaimedIn12Months]
      ,TC.[IsStaffIndicator]
      ,TC.[NewInCountry]
      ,TC.[FamilyName]
      ,TC.[FirstNameInArabic]
      ,TC.[MiddleNameInArabic]
      ,TC.[LastNameInArabic]
      ,TC.[FamilyNameInArabic]
      ,TC.[IsResident]
      ,TC.[ComNoOfPeopleEmployed]
      ,TC.[ComTradeLicensePlaceofIssue]
      ,TC.[AreaName]
      ,TC.[VillaOrApartmentNumber]
      ,TC.[AreaCodeId]
      ,TC.[OfficeTelephonenumberExtension]
      ,TC.[CityId]
      ,TC.[EmiratesCardNumber]
      ,TC.[EmiratesCardPhoto]
      ,TC.[IsEmiratesCardSwiped]
      ,TC.[ResidencyStatus]
      ,TC.[IsUpdateStatustoTransaction]
	INTO #temp_table_LinkedTransactionClients
	FROM [TransactionClient] TC 
	CROSS JOIN [TransactionClient] P 
	INNER JOIN #temp_table_LinkedTransactions LT 
	ON P.Id = LT.TransactionClientId	 
	WHERE TC.Id =@TransactionClientIdToSync
	AND TC.isActive=1 AND P.isActive=1  	
    
	--Select * from #temp_table_LinkedTransactionClients	 


     -- BULK UPDATE TRANSACTION TABLE FROM LINKED TRANSACTIONs OF TEMP TABLE
	
	  UPDATE TC 
	  SET 
	   TC.[TitleId] =LT.[TitleId]
      ,TC.[FirstName] = LT.[FirstName]
      ,TC.[MiddleName] = LT.[MiddleName]
      ,TC.[LastName] = LT.[LastName]
      ,TC.[Initials] = LT.[Initials]
      ,TC.[DateofBirth] = LT.[DateofBirth]
      ,TC.[PlaceOfBirth] = LT.[PlaceOfBirth]
      ,TC.[Nationality] = LT.[Nationality]
      ,TC.[NoofDependents] = LT.[NoofDependents]
      ,TC.[MaritalStatusId] = LT.[MaritalStatusId]
      ,TC.[MarriageDate] = LT.[MarriageDate]
      ,TC.[GenderId] = LT.[GenderId]
      ,TC.[MothersMaidenName] = LT.[MothersMaidenName]
      ,TC.[UAEResidentSince] = LT.[UAEResidentSince]
      ,TC.[IDTypeId] = LT.[IDTypeId]
      ,TC.[IDNumber] = LT.[IDNumber]
      ,TC.[PassportNo] = LT.[PassportNo]
      ,TC.[PassportIssueDate] = LT.[PassportIssueDate]
      ,TC.[PassportExpiryDate] = LT.[PassportExpiryDate]
      ,TC.[PassportIssuePlace] = LT.[PassportIssuePlace]
      ,TC.[VisaNo] = LT.[VisaNo]
      ,TC.[VisaIssueDate] = LT.[VisaIssueDate]
      ,TC.[VisaExpiryDate] = LT.[VisaExpiryDate]
      ,TC.[VisaIssuePlace] = LT.[VisaIssuePlace]
      ,TC.[EmiratesIdNo] = LT.[EmiratesIdNo]
      ,TC.[EmiratesIdIssueDate] = LT.[EmiratesIdIssueDate]
      ,TC.[EmiratesIdExpiryDate] = LT.[EmiratesIdExpiryDate]
      ,TC.[EmiratesIdIssuePlace] = LT.[EmiratesIdIssuePlace]
      ,TC.[DriversLicenceNo] = LT.[DriversLicenceNo]
      ,TC.[DriversLicenceIssueDate] = LT.[DriversLicenceIssueDate]
      ,TC.[DriversLicenceExpiryDate] = LT.[DriversLicenceExpiryDate]
      ,TC.[DriversLicenceIssuePlace] = LT.[DriversLicenceIssuePlace]
      ,TC.[UAEDrivingLicenceNo] = LT.[UAEDrivingLicenceNo]
      ,TC.[PreferredName] = LT.[PreferredName]
      ,TC.[Mobile] = LT.[Mobile]
      ,TC.[AlternativeMobile] = LT.[AlternativeMobile]
      ,TC.[HomePhoneCode] = LT.[HomePhoneCode]
      ,TC.[HomePhoneNumber] = LT.[HomePhoneNumber]
      ,TC.[WorkPhoneCode] = LT.[WorkPhoneCode]
      ,TC.[WorkPhoneNumber] = LT.[WorkPhoneNumber]
      ,TC.[FaxCode] = LT.[FaxCode]
      ,TC.[FaxNumber] = LT.[FaxNumber]
      ,TC.[ContactNumberInHomeCountry] = LT.[ContactNumberInHomeCountry]
      ,TC.[EmailAddress] = LT.[EmailAddress]
      ,TC.[IsSMSAlertRequired] = LT.[IsSMSAlertRequired]
      ,TC.[PreferedMailingAddress] = LT.[PreferedMailingAddress]
      ,TC.[NumberForSMSAlert] = LT.[NumberForSMSAlert]
      ,TC.[PhyAddBuildingName] = LT.[PhyAddBuildingName]
      ,TC.[PhyAddFlatNo] = LT.[PhyAddFlatNo]
      ,TC.[PhyAddUnitNo] = LT.[PhyAddUnitNo]
      ,TC.[PhyAddNearestLandmark] = LT.[PhyAddNearestLandmark]
      ,TC.[PhyAddArea] = LT.[PhyAddArea]
      ,TC.[PhyAddStreetName] = LT.[PhyAddStreetName]
      ,TC.[PostAddPOBoxNo] = LT.[PostAddPOBoxNo]
      ,TC.[PhyAddEmirate] = LT.[PhyAddEmirate]
      ,TC.[PhyAddCity] = LT.[PhyAddCity]
      ,TC.[PhyAddState] = LT.[PhyAddState]
      ,TC.[PhyAddCountryId] = LT.[PhyAddCountryId]
      ,TC.[PhyAddZipCode] = LT.[PhyAddZipCode]
      ,TC.[PostAddEmirate] = LT.[PostAddEmirate]
      ,TC.[ResidentialStatus] = LT.[ResidentialStatus]
      ,TC.[NoOfYearsAtPesentAddress] = LT.[NoOfYearsAtPesentAddress]
      ,TC.[PostAddCountryId] = LT.[PostAddCountryId]
      ,TC.[RentPerMonth] = LT.[RentPerMonth]
      ,TC.[AddressInHomeCountry] = LT.[AddressInHomeCountry]
      ,TC.[HomeCountryId] = LT.[HomeCountryId]
      ,TC.[BankingDetailsId] = LT.[BankingDetailsId]
      ,TC.[CustomerType] = LT.[CustomerType]
      ,TC.[NameOfKin] = LT.[NameOfKin]
      ,TC.[AddressOfKin] = LT.[AddressOfKin]
      ,TC.[ContactOfKin] = LT.[ContactOfKin]
      ,TC.[CountryId] = LT.[CountryId]
      ,TC.[IsActive] = LT.[IsActive]
      --,TC.[CreatedDate]      --= LT.[CreatedDate]
      --,TC.[ModifiedDate]      --= LT.[ModifiedDate]
      --,TC.[CreatedBy]      --= LT.[CreatedBy]
      --,TC.[ModifiedBy]      --= LT.[ModifiedBy]
      ,TC.[IsGuarantorApplication] = LT.[IsGuarantorApplication]
      ,TC.[RegularDriver] = LT.[RegularDriver]
      ,TC.[ConditionsResidentPermit] = LT.[ConditionsResidentPermit]
      ,TC.[LanguageId] = LT.[LanguageId]
      ,TC.[MarrageTypeId] = LT.[MarrageTypeId]
      ,TC.[SpousesName] = LT.[SpousesName]
      ,TC.[SpousesBirthDate] = LT.[SpousesBirthDate]
      ,TC.[PhyAddSurburb] = LT.[PhyAddSurburb]
      ,TC.[PhyAddTown] = LT.[PhyAddTown]
      ,TC.[PostAddSurburb] = LT.[PostAddSurburb]
      ,TC.[PostAddTown] = LT.[PostAddTown]
      ,TC.[SpecifyResidentialStatus] = LT.[SpecifyResidentialStatus]
      ,TC.[PreviousHomeAddress] = LT.[PreviousHomeAddress]
      ,TC.[PreferredCallTime] = LT.[PreferredCallTime]
      ,TC.[CompanyName] = LT.[CompanyName]
      ,TC.[ComNatureOfBusiness] = LT.[ComNatureOfBusiness]
      ,TC.[CompanyStartDate] = LT.[CompanyStartDate]
      ,TC.[ComTradeLicenceStartDate] = LT.[ComTradeLicenceStartDate]
      ,TC.[ComTradeLicenceExpiryDate] = LT.[ComTradeLicenceExpiryDate]
      ,TC.[ComVATNumber] = LT.[ComVATNumber]
      ,TC.[ComPhyAddBuildingName] = LT.[ComPhyAddBuildingName]
      ,TC.[ComPhyAddStreetName] = LT.[ComPhyAddStreetName]
      ,TC.[ComPhyAddEmirate] = LT.[ComPhyAddEmirate]
      ,TC.[ComPhyAddPostCode] = LT.[ComPhyAddPostCode]
      ,TC.[ComPhyAddCountryId] = LT.[ComPhyAddCountryId]
      ,TC.[ComTradingAs] = LT.[ComTradingAs]
      ,TC.[ComRegistrationNumber] = LT.[ComRegistrationNumber]
      ,TC.[ComNoOfYearsInBusiness] = LT.[ComNoOfYearsInBusiness]
      ,TC.[ComLandlord] = LT.[ComLandlord]
      ,TC.[ComHoldingCompany] = LT.[ComHoldingCompany]
      ,TC.[ComAssociatedCompany] = LT.[ComAssociatedCompany]
      ,TC.[ComSubsidaryCompany] = LT.[ComSubsidaryCompany]
      ,TC.[ComCompanyRepresentative] = LT.[ComCompanyRepresentative]
      ,TC.[ComFloorNo] = LT.[ComFloorNo]
      ,TC.[ComYearsAtCurrentAddress] = LT.[ComYearsAtCurrentAddress]
      ,TC.[ComEmirate] = LT.[ComEmirate]
      ,TC.[PhyAdd1] = LT.[PhyAdd1]
      ,TC.[PhyAdd2] = LT.[PhyAdd2]
      ,TC.[PhyAdd3] = LT.[PhyAdd3]
      ,TC.[PostAdd1] = LT.[PostAdd1]
      ,TC.[PostAdd2] = LT.[PostAdd2]
      ,TC.[PostAdd3] = LT.[PostAdd3]
      ,TC.[FinanceStatus] = LT.[FinanceStatus]
      ,TC.[FinanceStatusNotes] = LT.[FinanceStatusNotes]
      ,TC.[ConditionsOfResidentsPermit] = LT.[ConditionsOfResidentsPermit]
      ,TC.[BusinessTypeId] = LT.[BusinessTypeId]
      ,TC.[QualificationId] = LT.[QualificationId]
      ,TC.[PermitNumber] = LT.[PermitNumber]
      ,TC.[PermitIssueDate] = LT.[PermitIssueDate]
      ,TC.[PermitExpiryDate] = LT.[PermitExpiryDate]
      ,TC.[IdIssueDate] = LT.[IdIssueDate]
      ,TC.[IdExpiryDate] = LT.[IdExpiryDate]
      ,TC.[SpecifyMaritalStatus] = LT.[SpecifyMaritalStatus]
      ,TC.[EthnicGroup] = LT.[EthnicGroup]
      ,TC.[MarketingSource] = LT.[MarketingSource]
      ,TC.[ClaimFreeGroup] = LT.[ClaimFreeGroup]
      ,TC.[IsCompanyVATRegistered] = LT.[IsCompanyVATRegistered]
      ,TC.[PhyAdd4] = LT.[PhyAdd4]
      ,TC.[PhyAddCode] = LT.[PhyAddCode]
      ,TC.[PostAdd4] = LT.[PostAdd4]
      ,TC.[PostAddCode] = LT.[PostAddCode]
      ,TC.[IsCompanyBlackOwned] = LT.[IsCompanyBlackOwned]
      ,TC.[IsCompanyBalanceSheet] = LT.[IsCompanyBalanceSheet]
      ,TC.[CompanyFinancialYear] = LT.[CompanyFinancialYear]
      ,TC.[CompanyTurnover] = LT.[CompanyTurnover]
      ,TC.[CompanyTotalAssets] = LT.[CompanyTotalAssets]
      ,TC.[NoOfMonthsAtPesentAddress] = LT.[NoOfMonthsAtPesentAddress]
      ,TC.[ComPhyAdd1] = LT.[ComPhyAdd1]
      ,TC.[ComPhyAdd2] = LT.[ComPhyAdd2]
      ,TC.[ComPhyAdd3] = LT.[ComPhyAdd3]
      ,TC.[ComPhyAdd4] = LT.[ComPhyAdd4]
      ,TC.[ComPhyAddCode] = LT.[ComPhyAddCode]
      ,TC.[HomeCountryAddress1] = LT.[HomeCountryAddress1]
      ,TC.[HomeCountryAddress2] = LT.[HomeCountryAddress2]
      ,TC.[HomeCountryAddress3] = LT.[HomeCountryAddress3]
      ,TC.[HomeCountryAddress4] = LT.[HomeCountryAddress4]
      ,TC.[HomeCountryAddressCode] = LT.[HomeCountryAddressCode]
      ,TC.[PreferredLanguage] = LT.[PreferredLanguage]
      ,TC.[TradeLicenseNumber] = LT.[TradeLicenseNumber]
      ,TC.[IsSpouseDetailsIncluded] = LT.[IsSpouseDetailsIncluded]
      ,TC.[ComPhyAddMakaniNumber] = LT.[ComPhyAddMakaniNumber]
      ,TC.[OfficeBuildingName] = LT.[OfficeBuildingName]
      ,TC.[OfficeStreetName] = LT.[OfficeStreetName]
      ,TC.[OfficeEmirate] = LT.[OfficeEmirate]
      ,TC.[OfficeCountry] = LT.[OfficeCountry]
      ,TC.[OfficeNearestLandmark] = LT.[OfficeNearestLandmark]
      ,TC.[OfficeMakaniNumber] = LT.[OfficeMakaniNumber]
      ,TC.[ComNumberofFleetVehicles] = LT.[ComNumberofFleetVehicles]
      ,TC.[ComNumberofMortgagedVehicles] = LT.[ComNumberofMortgagedVehicles]
      ,TC.[IsClientClaimedIn12Months] = LT.[IsClientClaimedIn12Months]
      ,TC.[IsStaffIndicator] = LT.[IsStaffIndicator]
      ,TC.[NewInCountry] = LT.[NewInCountry]
      ,TC.[FamilyName] = LT.[FamilyName]
      ,TC.[FirstNameInArabic] = LT.[FirstNameInArabic]
      ,TC.[MiddleNameInArabic] = LT.[MiddleNameInArabic]
      ,TC.[LastNameInArabic] = LT.[LastNameInArabic]
      ,TC.[FamilyNameInArabic] = LT.[FamilyNameInArabic]
      ,TC.[IsResident] = LT.[IsResident]
      ,TC.[ComNoOfPeopleEmployed] = LT.[ComNoOfPeopleEmployed]
      ,TC.[ComTradeLicensePlaceofIssue] = LT.[ComTradeLicensePlaceofIssue]
      ,TC.[AreaName] = LT.[AreaName]
      ,TC.[VillaOrApartmentNumber] = LT.[VillaOrApartmentNumber]
      ,TC.[AreaCodeId] = LT.[AreaCodeId]
      ,TC.[OfficeTelephonenumberExtension] = LT.[OfficeTelephonenumberExtension]
      ,TC.[CityId] = LT.[CityId]
      ,TC.[EmiratesCardNumber] = LT.[EmiratesCardNumber]
      ,TC.[EmiratesCardPhoto] = LT.[EmiratesCardPhoto]
      ,TC.[IsEmiratesCardSwiped] = LT.[IsEmiratesCardSwiped]
      ,TC.[ResidencyStatus] = LT.[ResidencyStatus]
      ,TC.[IsUpdateStatustoTransaction] = LT.[IsUpdateStatustoTransaction]

	  FROM #temp_table_LinkedTransactionClients AS LT
	  INNER JOIN [TransactionClient] TC 
	  ON TC.[Id] = LT.[Id]
	  
	  --------------------TO Comment----------------------------
	  --Select * FROM  [TransactionClient] AS TC
	  --INNER JOIN #temp_table_LinkedTransactionClients AS LT
	  --ON TC.[Id] = LT.[Id]
	  --print('test point 5')   
	 
	   
	/*-------------------- Transaction Client Ends ----------------------------*/


	/*-------------------- Contacts Starts ----------------------------*/

	IF OBJECT_ID('tempdb..#temp_table_LinkedTransactionContactsToUpdate') IS NOT NULL
    DROP TABLE #temp_table_LinkedTransactionContactsToUpdate

	IF OBJECT_ID('tempdb..#temp_table_LinkedTransactionContactsToAdd') IS NOT NULL
    DROP TABLE #temp_table_LinkedTransactionContactsToAdd

	IF OBJECT_ID('tempdb..#temp_table_LinkedTransactionContactsToAdd1') IS NOT NULL
    DROP TABLE #temp_table_LinkedTransactionContactsToAdd1
		
    -------------------   Contacts To Update -------------------------------		
	Select  
	   P.[Id] 	  
	  ,P.[TransactionId]
      ,TC.[Title]
      ,TC.[LastName]
      ,TC.[FirstName]
      ,TC.[MobileNumber]
      ,TC.[AlternativeMobileNumber]
      ,TC.[WorkTelephoneNumber]
      ,TC.[CountryId]    
      ,GETUTCDATE() as [ModifiedDate]    
      ,@UserId as [ModifiedBy]
      ,TC.[RelationshipId]
	  ,TC.[SpouseEmployerName]
      ,TC.[SpouseEmployerAddress]
      ,TC.[SpouseOccupationId]
      ,TC.[PeriodOfEmployment]
      ,TC.[IsRegularDriver]
      ,TC.[GenderId]
      ,TC.[Initials]
      ,TC.[HomePhoneCode]
      ,TC.[HomePhoneNumber]
      ,TC.[WorkPhoneCode]
      ,TC.[WorkPhoneNumber]
      ,TC.[IsSecondInsured]
      ,TC.[MiddleName]
      ,TC.[DriversLicenceNo]
      ,TC.[DriversLicenceIssueDate]
      ,TC.[DriversLicenceExpiryDate]
      ,TC.[DriversLicenceIssuePlace]
      ,TC.[Nationality]
      ,TC.[DateofBirth]
      ,TC.[PassportNo]
      ,TC.[PassportIssueDate]
      ,TC.[PassportExpiryDate]
      ,TC.[VisaNo]
      ,TC.[VisaIssueDate]
      ,TC.[VisaExpiryDate]
      ,TC.[EmiratesIdNo]
      ,TC.[EmiratesIdIssueDate]
      ,TC.[EmiratesIdExpiryDate]
      ,TC.[EmiratesIdIssuePlace]
      ,TC.[PhyAddBuildingName]
      ,TC.[PhyAddArea]
      ,TC.[PhyAddEmirate]
      ,TC.[PhyAddCountryId]
      ,TC.[PostAddPOBoxNo]
      ,TC.[PostAddEmirate]
      ,TC.[PostAddCountryId]
      ,TC.[ResidentialStatus]
      ,TC.[QualificationLevelId]
      ,TC.[EmailAddress]
      ,TC.[PhyAdd1]
      ,TC.[PhyAdd2]
      ,TC.[PhyAdd3]
      ,TC.[PostAdd1]
      ,TC.[PostAdd2]
      ,TC.[PostAdd3]
      ,TC.[IDNumber]
      ,TC.[IdIssueDate]
      ,TC.[IdExpiryDate]
      ,TC.[PermitNumber]
      ,TC.[PermitIssueDate]
      ,TC.[PermitExpiryDate]
      ,TC.[UAEResidentSince]
      ,TC.[Occupation]
      ,TC.[Designation]
      ,TC.[PhyAdd4]
      ,TC.[PhyAddCode]
      ,TC.[PostAdd4]
      ,TC.[PostAddCode]
      ,TC.[LanguageId]
      ,TC.[ConditionsOfResidentsPermit]
      ,TC.[MaritalStatusId]
      ,TC.[MarriageDate]
      ,TC.[NoofDependents]
      ,TC.[MarrageTypeId]
      ,TC.[SpecifyMaritalStatus]
      ,TC.[NoOfYearsAtPesentAddress]
      ,TC.[NoOfMonthsAtPesentAddress]
      ,TC.[PreferedMailingAddress]
      ,TC.[PreferedContactMethod]
      ,TC.[CountryOfBirth]
      ,TC.[PreviousAdd1]
      ,TC.[PreviousAdd2]
      ,TC.[PreviousAdd3]
      ,TC.[PreviousAdd4]
      ,TC.[PreviousAddCode]
      ,TC.[NoOfYearsAtPreviousAddress]
      ,TC.[NoOfMonthsAtPreviousAddress]
      ,TC.[IsDualCitizenship]
      ,TC.[DualCitizenshipCountryId]
      ,TC.[HomeCountryId]
      ,TC.[AddressInHomeCountry]
      ,TC.[ContactNumberInHomeCountry]
      ,TC.[ShareholdingPercentage]
      ,TC.[IsOwnHome]
      ,TC.[HomeCountryAddress1]
      ,TC.[HomeCountryAddress2]
      ,TC.[HomeCountryAddress3]
      ,TC.[HomeCountryAddress4]
      ,TC.[HomeCountryAddressCode]
      ,TC.[IsContract]
      ,TC.[IsSurety]
      ,TC.[IsThirdPartyRegistration]
      ,TC.[JoiningDate]
      ,TC.[MakaniNumber]
      ,TC.[TradeLicenseNumber]
      ,TC.[TradelicenseExpiryDate]
      ,TC.[DateofInception]
      ,TC.[EmploymentCategoryId]
      ,TC.[PhyAddNearestLandMark]
      ,TC.[FaxCode]
      ,TC.[FaxNumber]
      ,TC.[FamilyName]
      ,TC.[AreaName]
      ,TC.[VillaOrApartmentNumber]
      ,TC.[AreaCodeId]
      ,TC.[OfficeTelephonenumberExtension]
      ,TC.[CityId]
      ,TC.[NoOfYearsWithEmployer]
      ,TC.[NoOfMonthsWithEmployer]
      ,TC.[EmiratesCardNumber]
      ,TC.[EmiratesCardPhoto]
      ,TC.[IsEmiratesCardSwiped]
	  ,TC.Id as OldID
	INTO #temp_table_LinkedTransactionContactsToUpdate
	FROM [TransactionContact] TC 
	CROSS JOIN [TransactionContact] P 
	INNER JOIN #temp_table_LinkedTransactions LT 
	ON P.[TransactionId] = LT.[Id] 
	WHERE TC.[TransactionId] = @TransactionId
	AND ((P.[FirstName] = TC.[FirstName] AND P.[LastName] = TC.[LastName] AND P.[RelationshipId]=TC.[RelationshipId]  ))
	AND TC.isActive=1 AND P.isActive=1	 
	 
	
	--Select * from #temp_table_LinkedTransactionContactsToUpdate	  
		
	----- BULK UPDATE CONTACTS FROM LINKED TRANSACTIONs OF TEMP TABLE
	UPDATE TC 
	  SET   
	   TC.[Title]= LT.[Title]
      ,TC.[LastName]= LT.[LastName]
      ,TC.[FirstName]= LT.[FirstName]
      ,TC.[MobileNumber]= LT.[MobileNumber]
      ,TC.[AlternativeMobileNumber]= LT.[AlternativeMobileNumber]
      ,TC.[WorkTelephoneNumber]= LT.[WorkTelephoneNumber]
      ,TC.[CountryId] = LT.[CountryId]    
      ,TC.[ModifiedDate]=LT.[ModifiedDate]    
      ,TC.[ModifiedBy]=LT.[ModifiedBy]
      ,TC.[RelationshipId]= LT.[RelationshipId]
	  ,TC.[SpouseEmployerName]  = LT.[SpouseEmployerName]
	  ,TC.[SpouseEmployerAddress]= LT.[SpouseEmployerAddress]
      ,TC.[SpouseOccupationId]= LT.[SpouseOccupationId]
      ,TC.[PeriodOfEmployment]= LT.[PeriodOfEmployment]
      ,TC.[IsRegularDriver]= LT.[IsRegularDriver]
      ,TC.[GenderId]= LT.[GenderId]
      ,TC.[Initials]= LT.[Initials]
      ,TC.[HomePhoneCode]= LT.[HomePhoneCode]
      ,TC.[HomePhoneNumber]= LT.[HomePhoneNumber]
      ,TC.[WorkPhoneCode]= LT.[WorkPhoneCode]
      ,TC.[WorkPhoneNumber]= LT.[WorkPhoneNumber]
      ,TC.[IsSecondInsured]= LT.[IsSecondInsured]
      ,TC.[MiddleName]= LT.[MiddleName]
      ,TC.[DriversLicenceNo]= LT.[DriversLicenceNo]
      ,TC.[DriversLicenceIssueDate]= LT.[DriversLicenceIssueDate]
      ,TC.[DriversLicenceExpiryDate]= LT.[DriversLicenceExpiryDate]
      ,TC.[DriversLicenceIssuePlace]= LT.[DriversLicenceIssuePlace]
      ,TC.[Nationality]= LT.[Nationality]
      ,TC.[DateofBirth]= LT.[DateofBirth]
      ,TC.[PassportNo]= LT.[PassportNo]
      ,TC.[PassportIssueDate]= LT.[PassportIssueDate]
      ,TC.[PassportExpiryDate]= LT.[PassportExpiryDate]
      ,TC.[VisaNo]= LT.[VisaNo]
      ,TC.[VisaIssueDate]= LT.[VisaIssueDate]
      ,TC.[VisaExpiryDate]= LT.[VisaExpiryDate]
      ,TC.[EmiratesIdNo]= LT.[EmiratesIdNo]
      ,TC.[EmiratesIdIssueDate]= LT.[EmiratesIdIssueDate]
      ,TC.[EmiratesIdExpiryDate]= LT.[EmiratesIdExpiryDate]
      ,TC.[EmiratesIdIssuePlace]= LT.[EmiratesIdIssuePlace]
      ,TC.[PhyAddBuildingName]= LT.[PhyAddBuildingName]
      ,TC.[PhyAddArea]= LT.[PhyAddArea]
      ,TC.[PhyAddEmirate]= LT.[PhyAddEmirate]
      ,TC.[PhyAddCountryId]= LT.[PhyAddCountryId]
      ,TC.[PostAddPOBoxNo]= LT.[PostAddPOBoxNo]
      ,TC.[PostAddEmirate]= LT.[PostAddEmirate]
      ,TC.[PostAddCountryId]= LT.[PostAddCountryId]
      ,TC.[ResidentialStatus]= LT.[ResidentialStatus]
      ,TC.[QualificationLevelId]= LT.[QualificationLevelId]
      ,TC.[EmailAddress]= LT.[EmailAddress]
      ,TC.[PhyAdd1]= LT.[PhyAdd1]
      ,TC.[PhyAdd2]= LT.[PhyAdd2]
      ,TC.[PhyAdd3]= LT.[PhyAdd3]
      ,TC.[PostAdd1]= LT.[PostAdd1]
      ,TC.[PostAdd2]= LT.[PostAdd2]
      ,TC.[PostAdd3]= LT.[PostAdd3]
      ,TC.[IDNumber]= LT.[IDNumber]
      ,TC.[IdIssueDate]= LT.[IdIssueDate]
      ,TC.[IdExpiryDate]= LT.[IdExpiryDate]
      ,TC.[PermitNumber]= LT.[PermitNumber]
      ,TC.[PermitIssueDate]= LT.[PermitIssueDate]
      ,TC.[PermitExpiryDate]= LT.[PermitExpiryDate]
      ,TC.[UAEResidentSince]= LT.[UAEResidentSince]
      ,TC.[Occupation]= LT.[Occupation]
      ,TC.[Designation]= LT.[Designation]
      ,TC.[PhyAdd4]= LT.[PhyAdd4]
      ,TC.[PhyAddCode]= LT.[PhyAddCode]
      ,TC.[PostAdd4]= LT.[PostAdd4]
      ,TC.[PostAddCode]= LT.[PostAddCode]
      ,TC.[LanguageId]= LT.[LanguageId]
      ,TC.[ConditionsOfResidentsPermit]= LT.[ConditionsOfResidentsPermit]
      ,TC.[MaritalStatusId]= LT.[MaritalStatusId]
      ,TC.[MarriageDate]= LT.[MarriageDate]
      ,TC.[NoofDependents]= LT.[NoofDependents]
      ,TC.[MarrageTypeId]= LT.[MarrageTypeId]
      ,TC.[SpecifyMaritalStatus]= LT.[SpecifyMaritalStatus]
      ,TC.[NoOfYearsAtPesentAddress]= LT.[NoOfYearsAtPesentAddress]
      ,TC.[NoOfMonthsAtPesentAddress]= LT.[NoOfMonthsAtPesentAddress]
      ,TC.[PreferedMailingAddress]= LT.[PreferedMailingAddress]
      ,TC.[PreferedContactMethod]= LT.[PreferedContactMethod]
      ,TC.[CountryOfBirth]= LT.[CountryOfBirth]
      ,TC.[PreviousAdd1]= LT.[PreviousAdd1]
      ,TC.[PreviousAdd2]= LT.[PreviousAdd2]
      ,TC.[PreviousAdd3]= LT.[PreviousAdd3]
      ,TC.[PreviousAdd4]= LT.[PreviousAdd4]
      ,TC.[PreviousAddCode]= LT.[PreviousAddCode]
      ,TC.[NoOfYearsAtPreviousAddress]= LT.[NoOfYearsAtPreviousAddress]
      ,TC.[NoOfMonthsAtPreviousAddress]= LT.[NoOfMonthsAtPreviousAddress]
      ,TC.[IsDualCitizenship]= LT.[IsDualCitizenship]
      ,TC.[DualCitizenshipCountryId]= LT.[DualCitizenshipCountryId]
      ,TC.[HomeCountryId]= LT.[HomeCountryId]
      ,TC.[AddressInHomeCountry]= LT.[AddressInHomeCountry]
      ,TC.[ContactNumberInHomeCountry]= LT.[ContactNumberInHomeCountry]
      ,TC.[ShareholdingPercentage]= LT.[ShareholdingPercentage]
      ,TC.[IsOwnHome]= LT.[IsOwnHome]
      ,TC.[HomeCountryAddress1]= LT.[HomeCountryAddress1]
      ,TC.[HomeCountryAddress2]= LT.[HomeCountryAddress2]
      ,TC.[HomeCountryAddress3]= LT.[HomeCountryAddress3]
      ,TC.[HomeCountryAddress4]= LT.[HomeCountryAddress4]
      ,TC.[HomeCountryAddressCode]= LT.[HomeCountryAddressCode]
      ,TC.[IsContract]= LT.[IsContract]
      ,TC.[IsSurety]= LT.[IsSurety]
      ,TC.[IsThirdPartyRegistration]= LT.[IsThirdPartyRegistration]
      ,TC.[JoiningDate]= LT.[JoiningDate]
      ,TC.[MakaniNumber]= LT.[MakaniNumber]
      ,TC.[TradeLicenseNumber]= LT.[TradeLicenseNumber]
      ,TC.[TradelicenseExpiryDate]= LT.[TradelicenseExpiryDate]
      ,TC.[DateofInception]= LT.[DateofInception]
      ,TC.[EmploymentCategoryId]= LT.[EmploymentCategoryId]
      ,TC.[PhyAddNearestLandMark]= LT.[PhyAddNearestLandMark]
      ,TC.[FaxCode]= LT.[FaxCode]
      ,TC.[FaxNumber]= LT.[FaxNumber]
      ,TC.[FamilyName]= LT.[FamilyName]
      ,TC.[AreaName]= LT.[AreaName]
      ,TC.[VillaOrApartmentNumber]= LT.[VillaOrApartmentNumber]
      ,TC.[AreaCodeId]= LT.[AreaCodeId]
      ,TC.[OfficeTelephonenumberExtension]= LT.[OfficeTelephonenumberExtension]
      ,TC.[CityId]= LT.[CityId]
      ,TC.[NoOfYearsWithEmployer]= LT.[NoOfYearsWithEmployer]
      ,TC.[NoOfMonthsWithEmployer]= LT.[NoOfMonthsWithEmployer]
      ,TC.[EmiratesCardNumber]= LT.[EmiratesCardNumber]
      ,TC.[EmiratesCardPhoto]= LT.[EmiratesCardPhoto]
      ,TC.[IsEmiratesCardSwiped]= LT.[IsEmiratesCardSwiped]
	FROM #temp_table_LinkedTransactionContactsToUpdate AS LT
	INNER JOIN [TransactionContact] TC 
	ON TC.[Id] = LT.[Id]	  
	
	  --Select * FROM [TransactionContact] AS TC
	  --INNER JOIN #temp_table_LinkedTransactions AS LT
	  --ON TC.[TransactionId] = LT.[Id]
	  
	-------------------   Contacts To Add	 -------------------------------	
	
	Declare	@ContactUpdateCount [bigint] 
	SET @ContactUpdateCount = (Select Count(1) FROM #temp_table_LinkedTransactionContactsToUpdate )
		
	IF @ContactUpdateCount > 0 
	BEGIN		 	

	Select  
	   0 as [Id]
	  ,LT.[Id] as [TransactionId]
      ,TC.[Title]
      ,TC.[LastName]
      ,TC.[FirstName]
      ,TC.[MobileNumber]
      ,TC.[AlternativeMobileNumber]
      ,TC.[WorkTelephoneNumber]
      ,TC.[CountryId]
      ,TC.[IsActive]
      ,GETUTCDATE() as [CreatedDate]
      ,GETUTCDATE() as [ModifiedDate]
      ,@UserId as [CreatedBy]
      ,@UserId as [ModifiedBy]
      ,TC.[RelationshipId]
	  ,TC.[SpouseEmployerName]
      ,TC.[SpouseEmployerAddress]
      ,TC.[SpouseOccupationId]
      ,TC.[PeriodOfEmployment]
      ,TC.[IsRegularDriver]
      ,TC.[GenderId]
      ,TC.[Initials]
      ,TC.[HomePhoneCode]
      ,TC.[HomePhoneNumber]
      ,TC.[WorkPhoneCode]
      ,TC.[WorkPhoneNumber]
      ,TC.[IsSecondInsured]
      ,TC.[MiddleName]
      ,TC.[DriversLicenceNo]
      ,TC.[DriversLicenceIssueDate]
      ,TC.[DriversLicenceExpiryDate]
      ,TC.[DriversLicenceIssuePlace]
      ,TC.[Nationality]
      ,TC.[DateofBirth]
      ,TC.[PassportNo]
      ,TC.[PassportIssueDate]
      ,TC.[PassportExpiryDate]
      ,TC.[VisaNo]
      ,TC.[VisaIssueDate]
      ,TC.[VisaExpiryDate]
      ,TC.[EmiratesIdNo]
      ,TC.[EmiratesIdIssueDate]
      ,TC.[EmiratesIdExpiryDate]
      ,TC.[EmiratesIdIssuePlace]
      ,TC.[PhyAddBuildingName]
      ,TC.[PhyAddArea]
      ,TC.[PhyAddEmirate]
      ,TC.[PhyAddCountryId]
      ,TC.[PostAddPOBoxNo]
      ,TC.[PostAddEmirate]
      ,TC.[PostAddCountryId]
      ,TC.[ResidentialStatus]
      ,TC.[QualificationLevelId]
      ,TC.[EmailAddress]
      ,TC.[PhyAdd1]
      ,TC.[PhyAdd2]
      ,TC.[PhyAdd3]
      ,TC.[PostAdd1]
      ,TC.[PostAdd2]
      ,TC.[PostAdd3]
      ,TC.[IDNumber]
      ,TC.[IdIssueDate]
      ,TC.[IdExpiryDate]
      ,TC.[PermitNumber]
      ,TC.[PermitIssueDate]
      ,TC.[PermitExpiryDate]
      ,TC.[UAEResidentSince]
      ,TC.[Occupation]
      ,TC.[Designation]
      ,TC.[PhyAdd4]
      ,TC.[PhyAddCode]
      ,TC.[PostAdd4]
      ,TC.[PostAddCode]
      ,TC.[LanguageId]
      ,TC.[ConditionsOfResidentsPermit]
      ,TC.[MaritalStatusId]
      ,TC.[MarriageDate]
      ,TC.[NoofDependents]
      ,TC.[MarrageTypeId]
      ,TC.[SpecifyMaritalStatus]
      ,TC.[NoOfYearsAtPesentAddress]
      ,TC.[NoOfMonthsAtPesentAddress]
      ,TC.[PreferedMailingAddress]
      ,TC.[PreferedContactMethod]
      ,TC.[CountryOfBirth]
      ,TC.[PreviousAdd1]
      ,TC.[PreviousAdd2]
      ,TC.[PreviousAdd3]
      ,TC.[PreviousAdd4]
      ,TC.[PreviousAddCode]
      ,TC.[NoOfYearsAtPreviousAddress]
      ,TC.[NoOfMonthsAtPreviousAddress]
      ,TC.[IsDualCitizenship]
      ,TC.[DualCitizenshipCountryId]
      ,TC.[HomeCountryId]
      ,TC.[AddressInHomeCountry]
      ,TC.[ContactNumberInHomeCountry]
      ,TC.[ShareholdingPercentage]
      ,TC.[IsOwnHome]
      ,TC.[HomeCountryAddress1]
      ,TC.[HomeCountryAddress2]
      ,TC.[HomeCountryAddress3]
      ,TC.[HomeCountryAddress4]
      ,TC.[HomeCountryAddressCode]
      ,TC.[IsContract]
      ,TC.[IsSurety]
      ,TC.[IsThirdPartyRegistration]
      ,TC.[JoiningDate]
      ,TC.[MakaniNumber]
      ,TC.[TradeLicenseNumber]
      ,TC.[TradelicenseExpiryDate]
      ,TC.[DateofInception]
      ,TC.[EmploymentCategoryId]
      ,TC.[PhyAddNearestLandMark]
      ,TC.[FaxCode]
      ,TC.[FaxNumber]
      ,TC.[FamilyName]
      ,TC.[AreaName]
      ,TC.[VillaOrApartmentNumber]
      ,TC.[AreaCodeId]
      ,TC.[OfficeTelephonenumberExtension]
      ,TC.[CityId]
      ,TC.[NoOfYearsWithEmployer]
      ,TC.[NoOfMonthsWithEmployer]
      ,TC.[EmiratesCardNumber]
      ,TC.[EmiratesCardPhoto]
      ,TC.[IsEmiratesCardSwiped]
	INTO #temp_table_LinkedTransactionContactsToAdd
	FROM [TransactionContact] TC 		 
	--INNER JOIN #temp_table_LinkedTransactionContactsToUpdate CTT ON TC.[Id] <> CTT.[OldID] 
	CROSS JOIN #temp_table_LinkedTransactions LT
	where TC.[TransactionId] = @TransactionId 
	
	--Select *  FROM #temp_table_LinkedTransactionContactsToAdd TC
	--WHERE NOT EXISTS
	--(  (Select CTT.* from #temp_table_LinkedTransactionContactsToUpdate CTT where 
	--TC.[TransactionId] = CTT.[TransactionId]  AND TC.[FirstName] = CTT.[FirstName] ANd  TC.[LastName] = CTT.[LastName])
	--)	

	--BULK INSERT INTO THE TABLE	
	INSERT INTO [dbo].[TransactionContact]
    (
	   [TransactionId]
      ,[Title]
      ,[LastName]
      ,[FirstName]
      ,[MobileNumber]
      ,[AlternativeMobileNumber]
      ,[WorkTelephoneNumber]
      ,[CountryId]
      ,[IsActive]
      ,[CreatedDate]
      ,[ModifiedDate]
      ,[CreatedBy]
      ,[ModifiedBy]
      ,[RelationshipId]
	  ,[SpouseEmployerName]
      ,[SpouseEmployerAddress]
      ,[SpouseOccupationId]
      ,[PeriodOfEmployment]
      ,[IsRegularDriver]
      ,[GenderId]
      ,[Initials]
      ,[HomePhoneCode]
      ,[HomePhoneNumber]
      ,[WorkPhoneCode]
      ,[WorkPhoneNumber]
      ,[IsSecondInsured]
      ,[MiddleName]
      ,[DriversLicenceNo]
      ,[DriversLicenceIssueDate]
      ,[DriversLicenceExpiryDate]
      ,[DriversLicenceIssuePlace]
      ,[Nationality]
      ,[DateofBirth]
      ,[PassportNo]
      ,[PassportIssueDate]
      ,[PassportExpiryDate]
      ,[VisaNo]
      ,[VisaIssueDate]
      ,[VisaExpiryDate]
      ,[EmiratesIdNo]
      ,[EmiratesIdIssueDate]
      ,[EmiratesIdExpiryDate]
      ,[EmiratesIdIssuePlace]
      ,[PhyAddBuildingName]
      ,[PhyAddArea]
      ,[PhyAddEmirate]
      ,[PhyAddCountryId]
      ,[PostAddPOBoxNo]
      ,[PostAddEmirate]
      ,[PostAddCountryId]
      ,[ResidentialStatus]
      ,[QualificationLevelId]
      ,[EmailAddress]
      ,[PhyAdd1]
      ,[PhyAdd2]
      ,[PhyAdd3]
      ,[PostAdd1]
      ,[PostAdd2]
      ,[PostAdd3]
      ,[IDNumber]
      ,[IdIssueDate]
      ,[IdExpiryDate]
      ,[PermitNumber]
      ,[PermitIssueDate]
      ,[PermitExpiryDate]
      ,[UAEResidentSince]
      ,[Occupation]
      ,[Designation]
      ,[PhyAdd4]
      ,[PhyAddCode]
      ,[PostAdd4]
      ,[PostAddCode]
      ,[LanguageId]
      ,[ConditionsOfResidentsPermit]
      ,[MaritalStatusId]
      ,[MarriageDate]
      ,[NoofDependents]
      ,[MarrageTypeId]
      ,[SpecifyMaritalStatus]
      ,[NoOfYearsAtPesentAddress]
      ,[NoOfMonthsAtPesentAddress]
      ,[PreferedMailingAddress]
      ,[PreferedContactMethod]
      ,[CountryOfBirth]
      ,[PreviousAdd1]
      ,[PreviousAdd2]
      ,[PreviousAdd3]
      ,[PreviousAdd4]
      ,[PreviousAddCode]
      ,[NoOfYearsAtPreviousAddress]
      ,[NoOfMonthsAtPreviousAddress]
      ,[IsDualCitizenship]
      ,[DualCitizenshipCountryId]
      ,[HomeCountryId]
      ,[AddressInHomeCountry]
      ,[ContactNumberInHomeCountry]
      ,[ShareholdingPercentage]
      ,[IsOwnHome]
      ,[HomeCountryAddress1]
      ,[HomeCountryAddress2]
      ,[HomeCountryAddress3]
      ,[HomeCountryAddress4]
      ,[HomeCountryAddressCode]
      ,[IsContract]
      ,[IsSurety]
      ,[IsThirdPartyRegistration]
      ,[JoiningDate]
      ,[MakaniNumber]
      ,[TradeLicenseNumber]
      ,[TradelicenseExpiryDate]
      ,[DateofInception]
      ,[EmploymentCategoryId]
      ,[PhyAddNearestLandMark]
      ,[FaxCode]
      ,[FaxNumber]
      ,[FamilyName]
      ,[AreaName]
      ,[VillaOrApartmentNumber]
      ,[AreaCodeId]
      ,[OfficeTelephonenumberExtension]
      ,[CityId]
      ,[NoOfYearsWithEmployer]
      ,[NoOfMonthsWithEmployer]
      ,[EmiratesCardNumber]
      ,[EmiratesCardPhoto]
      ,[IsEmiratesCardSwiped]
	)
	SELECT  
	   [TransactionId]
      ,TC.[Title]
      ,TC.[LastName]
      ,TC.[FirstName]
      ,TC.[MobileNumber]
      ,TC.[AlternativeMobileNumber]
      ,TC.[WorkTelephoneNumber]
      ,TC.[CountryId]
      ,TC.[IsActive]
      ,TC.[CreatedDate]
      ,TC.[ModifiedDate]
      ,TC.[CreatedBy]
      ,TC.[ModifiedBy]
      ,TC.[RelationshipId]
	  ,TC.[SpouseEmployerName]
      ,TC.[SpouseEmployerAddress]
      ,TC.[SpouseOccupationId]
      ,TC.[PeriodOfEmployment]
      ,TC.[IsRegularDriver]
      ,TC.[GenderId]
      ,TC.[Initials]
      ,TC.[HomePhoneCode]
      ,TC.[HomePhoneNumber]
      ,TC.[WorkPhoneCode]
      ,TC.[WorkPhoneNumber]
      ,TC.[IsSecondInsured]
      ,TC.[MiddleName]
      ,TC.[DriversLicenceNo]
      ,TC.[DriversLicenceIssueDate]
      ,TC.[DriversLicenceExpiryDate]
      ,TC.[DriversLicenceIssuePlace]
      ,TC.[Nationality]
      ,TC.[DateofBirth]
      ,TC.[PassportNo]
      ,TC.[PassportIssueDate]
      ,TC.[PassportExpiryDate]
      ,TC.[VisaNo]
      ,TC.[VisaIssueDate]
      ,TC.[VisaExpiryDate]
      ,TC.[EmiratesIdNo]
      ,TC.[EmiratesIdIssueDate]
      ,TC.[EmiratesIdExpiryDate]
      ,TC.[EmiratesIdIssuePlace]
      ,TC.[PhyAddBuildingName]
      ,TC.[PhyAddArea]
      ,TC.[PhyAddEmirate]
      ,TC.[PhyAddCountryId]
      ,TC.[PostAddPOBoxNo]
      ,TC.[PostAddEmirate]
      ,TC.[PostAddCountryId]
      ,TC.[ResidentialStatus]
      ,TC.[QualificationLevelId]
      ,TC.[EmailAddress]
      ,TC.[PhyAdd1]
      ,TC.[PhyAdd2]
      ,TC.[PhyAdd3]
      ,TC.[PostAdd1]
      ,TC.[PostAdd2]
      ,TC.[PostAdd3]
      ,TC.[IDNumber]
      ,TC.[IdIssueDate]
      ,TC.[IdExpiryDate]
      ,TC.[PermitNumber]
      ,TC.[PermitIssueDate]
      ,TC.[PermitExpiryDate]
      ,TC.[UAEResidentSince]
      ,TC.[Occupation]
      ,TC.[Designation]
      ,TC.[PhyAdd4]
      ,TC.[PhyAddCode]
      ,TC.[PostAdd4]
      ,TC.[PostAddCode]
      ,TC.[LanguageId]
      ,TC.[ConditionsOfResidentsPermit]
      ,TC.[MaritalStatusId]
      ,TC.[MarriageDate]
      ,TC.[NoofDependents]
      ,TC.[MarrageTypeId]
      ,TC.[SpecifyMaritalStatus]
      ,TC.[NoOfYearsAtPesentAddress]
      ,TC.[NoOfMonthsAtPesentAddress]
      ,TC.[PreferedMailingAddress]
      ,TC.[PreferedContactMethod]
      ,TC.[CountryOfBirth]
      ,TC.[PreviousAdd1]
      ,TC.[PreviousAdd2]
      ,TC.[PreviousAdd3]
      ,TC.[PreviousAdd4]
      ,TC.[PreviousAddCode]
      ,TC.[NoOfYearsAtPreviousAddress]
      ,TC.[NoOfMonthsAtPreviousAddress]
      ,TC.[IsDualCitizenship]
      ,TC.[DualCitizenshipCountryId]
      ,TC.[HomeCountryId]
      ,TC.[AddressInHomeCountry]
      ,TC.[ContactNumberInHomeCountry]
      ,TC.[ShareholdingPercentage]
      ,TC.[IsOwnHome]
      ,TC.[HomeCountryAddress1]
      ,TC.[HomeCountryAddress2]
      ,TC.[HomeCountryAddress3]
      ,TC.[HomeCountryAddress4]
      ,TC.[HomeCountryAddressCode]
      ,TC.[IsContract]
      ,TC.[IsSurety]
      ,TC.[IsThirdPartyRegistration]
      ,TC.[JoiningDate]
      ,TC.[MakaniNumber]
      ,TC.[TradeLicenseNumber]
      ,TC.[TradelicenseExpiryDate]
      ,TC.[DateofInception]
      ,TC.[EmploymentCategoryId]
      ,TC.[PhyAddNearestLandMark]
      ,TC.[FaxCode]
      ,TC.[FaxNumber]
      ,TC.[FamilyName]
      ,TC.[AreaName]
      ,TC.[VillaOrApartmentNumber]
      ,TC.[AreaCodeId]
      ,TC.[OfficeTelephonenumberExtension]
      ,TC.[CityId]
      ,TC.[NoOfYearsWithEmployer]
      ,TC.[NoOfMonthsWithEmployer]
      ,TC.[EmiratesCardNumber]
      ,TC.[EmiratesCardPhoto]
      ,TC.[IsEmiratesCardSwiped]	
    FROM #temp_table_LinkedTransactionContactsToAdd TC
	WHERE NOT EXISTS
	(  (Select CTT.* from #temp_table_LinkedTransactionContactsToUpdate CTT where 
	TC.[TransactionId] = CTT.[TransactionId]  AND TC.[FirstName] = CTT.[FirstName] ANd  TC.[LastName] = CTT.[LastName]
	AND TC.[RelationshipId]=CTT.[RelationshipId] )
	)	

END
ELSE BEGIN

	Select  
	   0 as [Id]
	  ,LT.[Id] as [TransactionId]
      ,TC.[Title]
      ,TC.[LastName]
      ,TC.[FirstName]
      ,TC.[MobileNumber]
      ,TC.[AlternativeMobileNumber]
      ,TC.[WorkTelephoneNumber]
      ,TC.[CountryId]
      ,TC.[IsActive]
      ,GETUTCDATE() as [CreatedDate]
      ,GETUTCDATE() as [ModifiedDate]
      ,@UserId as [CreatedBy]
      ,@UserId as [ModifiedBy]
      ,TC.[RelationshipId]
	  ,TC.[SpouseEmployerName]
      ,TC.[SpouseEmployerAddress]
      ,TC.[SpouseOccupationId]
      ,TC.[PeriodOfEmployment]
      ,TC.[IsRegularDriver]
      ,TC.[GenderId]
      ,TC.[Initials]
      ,TC.[HomePhoneCode]
      ,TC.[HomePhoneNumber]
      ,TC.[WorkPhoneCode]
      ,TC.[WorkPhoneNumber]
      ,TC.[IsSecondInsured]
      ,TC.[MiddleName]
      ,TC.[DriversLicenceNo]
      ,TC.[DriversLicenceIssueDate]
      ,TC.[DriversLicenceExpiryDate]
      ,TC.[DriversLicenceIssuePlace]
      ,TC.[Nationality]
      ,TC.[DateofBirth]
      ,TC.[PassportNo]
      ,TC.[PassportIssueDate]
      ,TC.[PassportExpiryDate]
      ,TC.[VisaNo]
      ,TC.[VisaIssueDate]
      ,TC.[VisaExpiryDate]
      ,TC.[EmiratesIdNo]
      ,TC.[EmiratesIdIssueDate]
      ,TC.[EmiratesIdExpiryDate]
      ,TC.[EmiratesIdIssuePlace]
      ,TC.[PhyAddBuildingName]
      ,TC.[PhyAddArea]
      ,TC.[PhyAddEmirate]
      ,TC.[PhyAddCountryId]
      ,TC.[PostAddPOBoxNo]
      ,TC.[PostAddEmirate]
      ,TC.[PostAddCountryId]
      ,TC.[ResidentialStatus]
      ,TC.[QualificationLevelId]
      ,TC.[EmailAddress]
      ,TC.[PhyAdd1]
      ,TC.[PhyAdd2]
      ,TC.[PhyAdd3]
      ,TC.[PostAdd1]
      ,TC.[PostAdd2]
      ,TC.[PostAdd3]
      ,TC.[IDNumber]
      ,TC.[IdIssueDate]
      ,TC.[IdExpiryDate]
      ,TC.[PermitNumber]
      ,TC.[PermitIssueDate]
      ,TC.[PermitExpiryDate]
      ,TC.[UAEResidentSince]
      ,TC.[Occupation]
      ,TC.[Designation]
      ,TC.[PhyAdd4]
      ,TC.[PhyAddCode]
      ,TC.[PostAdd4]
      ,TC.[PostAddCode]
      ,TC.[LanguageId]
      ,TC.[ConditionsOfResidentsPermit]
      ,TC.[MaritalStatusId]
      ,TC.[MarriageDate]
      ,TC.[NoofDependents]
      ,TC.[MarrageTypeId]
      ,TC.[SpecifyMaritalStatus]
      ,TC.[NoOfYearsAtPesentAddress]
      ,TC.[NoOfMonthsAtPesentAddress]
      ,TC.[PreferedMailingAddress]
      ,TC.[PreferedContactMethod]
      ,TC.[CountryOfBirth]
      ,TC.[PreviousAdd1]
      ,TC.[PreviousAdd2]
      ,TC.[PreviousAdd3]
      ,TC.[PreviousAdd4]
      ,TC.[PreviousAddCode]
      ,TC.[NoOfYearsAtPreviousAddress]
      ,TC.[NoOfMonthsAtPreviousAddress]
      ,TC.[IsDualCitizenship]
      ,TC.[DualCitizenshipCountryId]
      ,TC.[HomeCountryId]
      ,TC.[AddressInHomeCountry]
      ,TC.[ContactNumberInHomeCountry]
      ,TC.[ShareholdingPercentage]
      ,TC.[IsOwnHome]
      ,TC.[HomeCountryAddress1]
      ,TC.[HomeCountryAddress2]
      ,TC.[HomeCountryAddress3]
      ,TC.[HomeCountryAddress4]
      ,TC.[HomeCountryAddressCode]
      ,TC.[IsContract]
      ,TC.[IsSurety]
      ,TC.[IsThirdPartyRegistration]
      ,TC.[JoiningDate]
      ,TC.[MakaniNumber]
      ,TC.[TradeLicenseNumber]
      ,TC.[TradelicenseExpiryDate]
      ,TC.[DateofInception]
      ,TC.[EmploymentCategoryId]
      ,TC.[PhyAddNearestLandMark]
      ,TC.[FaxCode]
      ,TC.[FaxNumber]
      ,TC.[FamilyName]
      ,TC.[AreaName]
      ,TC.[VillaOrApartmentNumber]
      ,TC.[AreaCodeId]
      ,TC.[OfficeTelephonenumberExtension]
      ,TC.[CityId]
      ,TC.[NoOfYearsWithEmployer]
      ,TC.[NoOfMonthsWithEmployer]
      ,TC.[EmiratesCardNumber]
      ,TC.[EmiratesCardPhoto]
      ,TC.[IsEmiratesCardSwiped]
	INTO #temp_table_LinkedTransactionContactsToAdd1
	FROM [TransactionContact] TC 		 
	CROSS JOIN #temp_table_LinkedTransactions LT
	where TC.[TransactionId] = @TransactionId 

	--Select *  FROM #temp_table_LinkedTransactionContactsToAdd1
	--BULK INSERT INTO THE TABLE	
	INSERT INTO [dbo].[TransactionContact]
    (
	   [TransactionId]
      ,[Title]
      ,[LastName]
      ,[FirstName]
      ,[MobileNumber]
      ,[AlternativeMobileNumber]
      ,[WorkTelephoneNumber]
      ,[CountryId]
      ,[IsActive]
      ,[CreatedDate]
      ,[ModifiedDate]
      ,[CreatedBy]
      ,[ModifiedBy]
      ,[RelationshipId]
	  ,[SpouseEmployerName]
      ,[SpouseEmployerAddress]
      ,[SpouseOccupationId]
      ,[PeriodOfEmployment]
      ,[IsRegularDriver]
      ,[GenderId]
      ,[Initials]
      ,[HomePhoneCode]
      ,[HomePhoneNumber]
      ,[WorkPhoneCode]
      ,[WorkPhoneNumber]
      ,[IsSecondInsured]
      ,[MiddleName]
      ,[DriversLicenceNo]
      ,[DriversLicenceIssueDate]
      ,[DriversLicenceExpiryDate]
      ,[DriversLicenceIssuePlace]
      ,[Nationality]
      ,[DateofBirth]
      ,[PassportNo]
      ,[PassportIssueDate]
      ,[PassportExpiryDate]
      ,[VisaNo]
      ,[VisaIssueDate]
      ,[VisaExpiryDate]
      ,[EmiratesIdNo]
      ,[EmiratesIdIssueDate]
      ,[EmiratesIdExpiryDate]
      ,[EmiratesIdIssuePlace]
      ,[PhyAddBuildingName]
      ,[PhyAddArea]
      ,[PhyAddEmirate]
      ,[PhyAddCountryId]
      ,[PostAddPOBoxNo]
      ,[PostAddEmirate]
      ,[PostAddCountryId]
      ,[ResidentialStatus]
      ,[QualificationLevelId]
      ,[EmailAddress]
      ,[PhyAdd1]
      ,[PhyAdd2]
      ,[PhyAdd3]
      ,[PostAdd1]
      ,[PostAdd2]
      ,[PostAdd3]
      ,[IDNumber]
      ,[IdIssueDate]
      ,[IdExpiryDate]
      ,[PermitNumber]
      ,[PermitIssueDate]
      ,[PermitExpiryDate]
      ,[UAEResidentSince]
      ,[Occupation]
      ,[Designation]
      ,[PhyAdd4]
      ,[PhyAddCode]
      ,[PostAdd4]
      ,[PostAddCode]
      ,[LanguageId]
      ,[ConditionsOfResidentsPermit]
      ,[MaritalStatusId]
      ,[MarriageDate]
      ,[NoofDependents]
      ,[MarrageTypeId]
      ,[SpecifyMaritalStatus]
      ,[NoOfYearsAtPesentAddress]
      ,[NoOfMonthsAtPesentAddress]
      ,[PreferedMailingAddress]
      ,[PreferedContactMethod]
      ,[CountryOfBirth]
      ,[PreviousAdd1]
      ,[PreviousAdd2]
      ,[PreviousAdd3]
      ,[PreviousAdd4]
      ,[PreviousAddCode]
      ,[NoOfYearsAtPreviousAddress]
      ,[NoOfMonthsAtPreviousAddress]
      ,[IsDualCitizenship]
      ,[DualCitizenshipCountryId]
      ,[HomeCountryId]
      ,[AddressInHomeCountry]
      ,[ContactNumberInHomeCountry]
      ,[ShareholdingPercentage]
      ,[IsOwnHome]
      ,[HomeCountryAddress1]
      ,[HomeCountryAddress2]
      ,[HomeCountryAddress3]
      ,[HomeCountryAddress4]
      ,[HomeCountryAddressCode]
      ,[IsContract]
      ,[IsSurety]
      ,[IsThirdPartyRegistration]
      ,[JoiningDate]
      ,[MakaniNumber]
      ,[TradeLicenseNumber]
      ,[TradelicenseExpiryDate]
      ,[DateofInception]
      ,[EmploymentCategoryId]
      ,[PhyAddNearestLandMark]
      ,[FaxCode]
      ,[FaxNumber]
      ,[FamilyName]
      ,[AreaName]
      ,[VillaOrApartmentNumber]
      ,[AreaCodeId]
      ,[OfficeTelephonenumberExtension]
      ,[CityId]
      ,[NoOfYearsWithEmployer]
      ,[NoOfMonthsWithEmployer]
      ,[EmiratesCardNumber]
      ,[EmiratesCardPhoto]
      ,[IsEmiratesCardSwiped]
	)
	SELECT  
	   [TransactionId]
      ,[Title]
      ,[LastName]
      ,[FirstName]
      ,[MobileNumber]
      ,[AlternativeMobileNumber]
      ,[WorkTelephoneNumber]
      ,[CountryId]
      ,[IsActive]
      ,[CreatedDate]
      ,[ModifiedDate]
      ,[CreatedBy]
      ,[ModifiedBy]
      ,[RelationshipId]
	  ,[SpouseEmployerName]
      ,[SpouseEmployerAddress]
      ,[SpouseOccupationId]
      ,[PeriodOfEmployment]
      ,[IsRegularDriver]
      ,[GenderId]
      ,[Initials]
      ,[HomePhoneCode]
      ,[HomePhoneNumber]
      ,[WorkPhoneCode]
      ,[WorkPhoneNumber]
      ,[IsSecondInsured]
      ,[MiddleName]
      ,[DriversLicenceNo]
      ,[DriversLicenceIssueDate]
      ,[DriversLicenceExpiryDate]
      ,[DriversLicenceIssuePlace]
      ,[Nationality]
      ,[DateofBirth]
      ,[PassportNo]
      ,[PassportIssueDate]
      ,[PassportExpiryDate]
      ,[VisaNo]
      ,[VisaIssueDate]
      ,[VisaExpiryDate]
      ,[EmiratesIdNo]
      ,[EmiratesIdIssueDate]
      ,[EmiratesIdExpiryDate]
      ,[EmiratesIdIssuePlace]
      ,[PhyAddBuildingName]
      ,[PhyAddArea]
      ,[PhyAddEmirate]
      ,[PhyAddCountryId]
      ,[PostAddPOBoxNo]
      ,[PostAddEmirate]
      ,[PostAddCountryId]
      ,[ResidentialStatus]
      ,[QualificationLevelId]
      ,[EmailAddress]
      ,[PhyAdd1]
      ,[PhyAdd2]
      ,[PhyAdd3]
      ,[PostAdd1]
      ,[PostAdd2]
      ,[PostAdd3]
      ,[IDNumber]
      ,[IdIssueDate]
      ,[IdExpiryDate]
      ,[PermitNumber]
      ,[PermitIssueDate]
      ,[PermitExpiryDate]
      ,[UAEResidentSince]
      ,[Occupation]
      ,[Designation]
      ,[PhyAdd4]
      ,[PhyAddCode]
      ,[PostAdd4]
      ,[PostAddCode]
      ,[LanguageId]
      ,[ConditionsOfResidentsPermit]
      ,[MaritalStatusId]
      ,[MarriageDate]
      ,[NoofDependents]
      ,[MarrageTypeId]
      ,[SpecifyMaritalStatus]
      ,[NoOfYearsAtPesentAddress]
      ,[NoOfMonthsAtPesentAddress]
      ,[PreferedMailingAddress]
      ,[PreferedContactMethod]
      ,[CountryOfBirth]
      ,[PreviousAdd1]
      ,[PreviousAdd2]
      ,[PreviousAdd3]
      ,[PreviousAdd4]
      ,[PreviousAddCode]
      ,[NoOfYearsAtPreviousAddress]
      ,[NoOfMonthsAtPreviousAddress]
      ,[IsDualCitizenship]
      ,[DualCitizenshipCountryId]
      ,[HomeCountryId]
      ,[AddressInHomeCountry]
      ,[ContactNumberInHomeCountry]
      ,[ShareholdingPercentage]
      ,[IsOwnHome]
      ,[HomeCountryAddress1]
      ,[HomeCountryAddress2]
      ,[HomeCountryAddress3]
      ,[HomeCountryAddress4]
      ,[HomeCountryAddressCode]
      ,[IsContract]
      ,[IsSurety]
      ,[IsThirdPartyRegistration]
      ,[JoiningDate]
      ,[MakaniNumber]
      ,[TradeLicenseNumber]
      ,[TradelicenseExpiryDate]
      ,[DateofInception]
      ,[EmploymentCategoryId]
      ,[PhyAddNearestLandMark]
      ,[FaxCode]
      ,[FaxNumber]
      ,[FamilyName]
      ,[AreaName]
      ,[VillaOrApartmentNumber]
      ,[AreaCodeId]
      ,[OfficeTelephonenumberExtension]
      ,[CityId]
      ,[NoOfYearsWithEmployer]
      ,[NoOfMonthsWithEmployer]
      ,[EmiratesCardNumber]
      ,[EmiratesCardPhoto]
      ,[IsEmiratesCardSwiped]	
    FROM #temp_table_LinkedTransactionContactsToAdd1 

END
/*-------------------- Transaction Contacts Ends ----------------------------*/



/*-------------------- Transaction Employer Starts ----------------------------*/

    --GET THE VALUES FROM TRANSACTION CLIENT TO SYNC FROM
	
	Declare	@TransactionEmpploymentIdToSync [bigint] 
	SET @TransactionEmpploymentIdToSync = (Select [Id] FROM [TransactionEmployerDetails] where [TransactionId] = @TransactionId AND [IsActive]=1)

	
	IF OBJECT_ID('tempdb..#temp_table_LinkedTransactionEmploymentToUpdate') IS NOT NULL
    DROP TABLE #temp_table_LinkedTransactionEmploymentToUpdate

	IF OBJECT_ID('tempdb..#temp_table_LinkedTransactionEmploymentToAdd') IS NOT NULL
    DROP TABLE #temp_table_LinkedTransactionEmploymentToAdd

	IF OBJECT_ID('tempdb..#temp_table_LinkedTransactionEmploymentToAdd1') IS NOT NULL
    DROP TABLE #temp_table_LinkedTransactionEmploymentToAdd1
			
	Select  
		P.[Id] 
	  ,LT.[Id] as [TransactionId]
      ,TC.[EmploymentTypeId]
      ,TC.[NameofEmployer]
      ,TC.[JoiningDate]
      ,TC.[EmployeeNumber]
      ,TC.[Designation]
      ,TC.[TypeOfOrganization]
      ,TC.[Sector]
      ,TC.[PreviousEmployer]
      ,TC.[NoOfYearsWithPreviousEmployer]
      ,TC.[BusinessName]
      ,TC.[DateofInception]
      ,TC.[TradeLicenceNo]
      ,TC.[TradeLicenceExpiryDate]     
      ,TC.[ModifiedDate]    
      ,TC.[ModifiedBy]
      ,TC.[CountryId]
      ,TC.[Occupation]
      ,TC.[SalaryCycle]
      ,TC.[NoOfEmployees]
      ,TC.[WebsiteOfEmployer]
      ,TC.[PhyAdd1]
      ,TC.[PhyAdd2]
      ,TC.[PhyAdd3]
      ,TC.[PhyAdd4]
      ,TC.[Code]
      ,TC.[NatureOfBusiness]
      ,TC.[EmploymentCategoryId]
      ,TC.[SectorId]
      ,TC.[MODRank]
      ,TC.[PreviousEmployerAddress]
      ,TC.[PreviousEmployerTelephoneNumberCode]
      ,TC.[PreviousEmployerTelephoneNumber]
      ,TC.[CurrentEmployerDateOfEstablishment]
      ,TC.[OccupationLevelId]
      ,TC.[DesignationId]
	  ,TC.Id as OldID
	INTO #temp_table_LinkedTransactionEmploymentToUpdate
	FROM [TransactionEmployerDetails] TC 
	CROSS JOIN [TransactionEmployerDetails] P 
	INNER JOIN #temp_table_LinkedTransactions LT 
	ON P.[TransactionId] = LT.[Id]	 
	WHERE TC.Id =@TransactionEmpploymentIdToSync 
	AND TC.isActive=1 AND P.isActive=1 
		  	
    --Select * from #temp_table_LinkedTransactionEmploymentToUpdate	 
	
     -- BULK UPDATE 
	
	  UPDATE TC 
	  SET 
	   TC.[EmploymentTypeId]= LT.[EmploymentTypeId]
      ,TC.[NameofEmployer]= LT.[NameofEmployer]
      ,TC.[JoiningDate]= LT.[JoiningDate]
      ,TC.[EmployeeNumber]= LT.[EmployeeNumber]
      ,TC.[Designation]= LT.[Designation]
      ,TC.[TypeOfOrganization]= LT.[TypeOfOrganization]
      ,TC.[Sector]= LT.[Sector]
      ,TC.[PreviousEmployer]= LT.[PreviousEmployer]
      ,TC.[NoOfYearsWithPreviousEmployer]= LT.[NoOfYearsWithPreviousEmployer]
      ,TC.[BusinessName]= LT.[BusinessName]
      ,TC.[DateofInception]= LT.[DateofInception]
      ,TC.[TradeLicenceNo]= LT.[TradeLicenceNo]
      ,TC.[TradeLicenceExpiryDate] = LT.[TradeLicenceExpiryDate]     
      ,TC.[ModifiedDate]  = LT.[ModifiedDate]    
      ,TC.[ModifiedBy]= LT.[ModifiedBy]
      ,TC.[CountryId]= LT.[CountryId]
      ,TC.[Occupation]= LT.[Occupation]
      ,TC.[SalaryCycle]= LT.[SalaryCycle]
      ,TC.[NoOfEmployees]= LT.[NoOfEmployees]
      ,TC.[WebsiteOfEmployer]= LT.[WebsiteOfEmployer]
      ,TC.[PhyAdd1]= LT.[PhyAdd1]
      ,TC.[PhyAdd2]= LT.[PhyAdd2]
      ,TC.[PhyAdd3]= LT.[PhyAdd3]
      ,TC.[PhyAdd4]= LT.[PhyAdd4]
      ,TC.[Code]= LT.[Code]
      ,TC.[NatureOfBusiness]= LT.[NatureOfBusiness]
      ,TC.[EmploymentCategoryId]= LT.[EmploymentCategoryId]
      ,TC.[SectorId]= LT.[SectorId]
      ,TC.[MODRank]= LT.[MODRank]
      ,TC.[PreviousEmployerAddress]= LT.[PreviousEmployerAddress]
      ,TC.[PreviousEmployerTelephoneNumberCode]= LT.[PreviousEmployerTelephoneNumberCode]
      ,TC.[PreviousEmployerTelephoneNumber]= LT.[PreviousEmployerTelephoneNumber]
      ,TC.[CurrentEmployerDateOfEstablishment]= LT.[CurrentEmployerDateOfEstablishment]
      ,TC.[OccupationLevelId]= LT.[OccupationLevelId]
      ,TC.[DesignationId]= LT.[DesignationId]
	  FROM #temp_table_LinkedTransactionEmploymentToUpdate AS LT
	  INNER JOIN [TransactionEmployerDetails] TC 
	  ON TC.[Id] = LT.[Id]
	  
	  --Select * FROM [TransactionEmployerDetails] AS TC
	  --INNER JOIN #temp_table_LinkedTransactionEmployment AS LT
	  --ON TC.[Id] = LT.[Id]

	  	Declare	@EmployerUpdateCount [bigint] 
		SET @EmployerUpdateCount = (Select Count(1) FROM #temp_table_LinkedTransactionEmploymentToUpdate )

		IF @EmployerUpdateCount>0 
		BEGIN

		Select  
			   0 as [Id]
			  ,LT.[Id] as [TransactionId]
			  ,TC.[EmploymentTypeId]
			  ,TC.[NameofEmployer]
			  ,TC.[JoiningDate]
			  ,TC.[EmployeeNumber]
			  ,TC.[Designation]
			  ,TC.[TypeOfOrganization]
			  ,TC.[Sector]
			  ,TC.[PreviousEmployer]
			  ,TC.[NoOfYearsWithPreviousEmployer]
			  ,TC.[BusinessName]
			  ,TC.[DateofInception]
			  ,TC.[TradeLicenceNo]
			  ,TC.[TradeLicenceExpiryDate]   
			  ,TC.[IsActive]  
			  ,GETUTCDATE() as [CreatedDate]
			  ,GETUTCDATE() as [ModifiedDate]
			  ,@UserId as [CreatedBy]
			  ,@UserId as [ModifiedBy]
			  ,TC.[CountryId]
			  ,TC.[Occupation]
			  ,TC.[SalaryCycle]
			  ,TC.[NoOfEmployees]
			  ,TC.[WebsiteOfEmployer]
			  ,TC.[PhyAdd1]
			  ,TC.[PhyAdd2]
			  ,TC.[PhyAdd3]
			  ,TC.[PhyAdd4]
			  ,TC.[Code]
			  ,TC.[NatureOfBusiness]
			  ,TC.[EmploymentCategoryId]
			  ,TC.[SectorId]
			  ,TC.[MODRank]
			  ,TC.[PreviousEmployerAddress]
			  ,TC.[PreviousEmployerTelephoneNumberCode]
			  ,TC.[PreviousEmployerTelephoneNumber]
			  ,TC.[CurrentEmployerDateOfEstablishment]
			  ,TC.[OccupationLevelId]
			  ,TC.[DesignationId]			  
			INTO #temp_table_LinkedTransactionEmploymentToAdd
			FROM [TransactionEmployerDetails] TC 		 
			INNER JOIN #temp_table_LinkedTransactionEmploymentToUpdate CTT ON TC.[Id] <> CTT.[OldID] 
			CROSS JOIN #temp_table_LinkedTransactions LT
			where TC.[TransactionId] = @TransactionId 

		--Select *  FROM #temp_table_LinkedTransactionEmploymentToAdd
		--BULK INSERT INTO THE TABLE	
		INSERT INTO [dbo].[TransactionEmployerDetails]
			(
			       [TransactionId]
				  ,[EmploymentTypeId]
				  ,[NameofEmployer]
				  ,[JoiningDate]
				  ,[EmployeeNumber]
				  ,[Designation]
				  ,[TypeOfOrganization]
				  ,[Sector]
				  ,[PreviousEmployer]
				  ,[NoOfYearsWithPreviousEmployer]
				  ,[BusinessName]
				  ,[DateofInception]
				  ,[TradeLicenceNo]
				  ,[TradeLicenceExpiryDate]
				  ,[CreatedDate]
				  ,[ModifiedDate]
				  ,[CreatedBy]
				  ,[ModifiedBy]
				  ,[IsActive]
				  ,[CountryId]
				  ,[Occupation]
				  ,[SalaryCycle]
				  ,[NoOfEmployees]
				  ,[WebsiteOfEmployer]
				  ,[PhyAdd1]
				  ,[PhyAdd2]
				  ,[PhyAdd3]
				  ,[PhyAdd4]
				  ,[Code]
				  ,[NatureOfBusiness]
				  ,[EmploymentCategoryId]
				  ,[SectorId]
				  ,[MODRank]
				  ,[PreviousEmployerAddress]
				  ,[PreviousEmployerTelephoneNumberCode]
				  ,[PreviousEmployerTelephoneNumber]
				  ,[CurrentEmployerDateOfEstablishment]
				  ,[OccupationLevelId]
				  ,[DesignationId]
			)
			SELECT  
			       [TransactionId]
				  ,[EmploymentTypeId]
				  ,[NameofEmployer]
				  ,[JoiningDate]
				  ,[EmployeeNumber]
				  ,[Designation]
				  ,[TypeOfOrganization]
				  ,[Sector]
				  ,[PreviousEmployer]
				  ,[NoOfYearsWithPreviousEmployer]
				  ,[BusinessName]
				  ,[DateofInception]
				  ,[TradeLicenceNo]
				  ,[TradeLicenceExpiryDate]
				  ,[CreatedDate]
				  ,[ModifiedDate]
				  ,[CreatedBy]
				  ,[ModifiedBy]
				  ,[IsActive]
				  ,[CountryId]
				  ,[Occupation]
				  ,[SalaryCycle]
				  ,[NoOfEmployees]
				  ,[WebsiteOfEmployer]
				  ,[PhyAdd1]
				  ,[PhyAdd2]
				  ,[PhyAdd3]
				  ,[PhyAdd4]
				  ,[Code]
				  ,[NatureOfBusiness]
				  ,[EmploymentCategoryId]
				  ,[SectorId]
				  ,[MODRank]
				  ,[PreviousEmployerAddress]
				  ,[PreviousEmployerTelephoneNumberCode]
				  ,[PreviousEmployerTelephoneNumber]
				  ,[CurrentEmployerDateOfEstablishment]
				  ,[OccupationLevelId]
				  ,[DesignationId]
			FROM #temp_table_LinkedTransactionEmploymentToAdd
			

		END
		ELSE BEGIN

				Select  
			   0 as [Id]
			  ,LT.[Id] as [TransactionId]
			  ,TC.[EmploymentTypeId]
			  ,TC.[NameofEmployer]
			  ,TC.[JoiningDate]
			  ,TC.[EmployeeNumber]
			  ,TC.[Designation]
			  ,TC.[TypeOfOrganization]
			  ,TC.[Sector]
			  ,TC.[PreviousEmployer]
			  ,TC.[NoOfYearsWithPreviousEmployer]
			  ,TC.[BusinessName]
			  ,TC.[DateofInception]
			  ,TC.[TradeLicenceNo]
			  ,TC.[TradeLicenceExpiryDate]   
			  ,TC.[IsActive]  
			  ,GETUTCDATE() as [CreatedDate]
			  ,GETUTCDATE() as [ModifiedDate]
			  ,@UserId as [CreatedBy]
			  ,@UserId as [ModifiedBy]
			  ,TC.[CountryId]
			  ,TC.[Occupation]
			  ,TC.[SalaryCycle]
			  ,TC.[NoOfEmployees]
			  ,TC.[WebsiteOfEmployer]
			  ,TC.[PhyAdd1]
			  ,TC.[PhyAdd2]
			  ,TC.[PhyAdd3]
			  ,TC.[PhyAdd4]
			  ,TC.[Code]
			  ,TC.[NatureOfBusiness]
			  ,TC.[EmploymentCategoryId]
			  ,TC.[SectorId]
			  ,TC.[MODRank]
			  ,TC.[PreviousEmployerAddress]
			  ,TC.[PreviousEmployerTelephoneNumberCode]
			  ,TC.[PreviousEmployerTelephoneNumber]
			  ,TC.[CurrentEmployerDateOfEstablishment]
			  ,TC.[OccupationLevelId]
			  ,TC.[DesignationId]			  
			INTO #temp_table_LinkedTransactionEmploymentToAdd1
			FROM [TransactionEmployerDetails] TC 		 
			CROSS JOIN #temp_table_LinkedTransactions LT
			where TC.[TransactionId] = @TransactionId 

		--Select *  FROM #temp_table_LinkedTransactionEmploymentToAdd1
		--BULK INSERT INTO THE TABLE	
		INSERT INTO [dbo].[TransactionEmployerDetails]
			(
			       [TransactionId]
				  ,[EmploymentTypeId]
				  ,[NameofEmployer]
				  ,[JoiningDate]
				  ,[EmployeeNumber]
				  ,[Designation]
				  ,[TypeOfOrganization]
				  ,[Sector]
				  ,[PreviousEmployer]
				  ,[NoOfYearsWithPreviousEmployer]
				  ,[BusinessName]
				  ,[DateofInception]
				  ,[TradeLicenceNo]
				  ,[TradeLicenceExpiryDate]
				  ,[CreatedDate]
				  ,[ModifiedDate]
				  ,[CreatedBy]
				  ,[ModifiedBy]
				  ,[IsActive]
				  ,[CountryId]
				  ,[Occupation]
				  ,[SalaryCycle]
				  ,[NoOfEmployees]
				  ,[WebsiteOfEmployer]
				  ,[PhyAdd1]
				  ,[PhyAdd2]
				  ,[PhyAdd3]
				  ,[PhyAdd4]
				  ,[Code]
				  ,[NatureOfBusiness]
				  ,[EmploymentCategoryId]
				  ,[SectorId]
				  ,[MODRank]
				  ,[PreviousEmployerAddress]
				  ,[PreviousEmployerTelephoneNumberCode]
				  ,[PreviousEmployerTelephoneNumber]
				  ,[CurrentEmployerDateOfEstablishment]
				  ,[OccupationLevelId]
				  ,[DesignationId]
			)
			SELECT  
			       [TransactionId]
				  ,[EmploymentTypeId]
				  ,[NameofEmployer]
				  ,[JoiningDate]
				  ,[EmployeeNumber]
				  ,[Designation]
				  ,[TypeOfOrganization]
				  ,[Sector]
				  ,[PreviousEmployer]
				  ,[NoOfYearsWithPreviousEmployer]
				  ,[BusinessName]
				  ,[DateofInception]
				  ,[TradeLicenceNo]
				  ,[TradeLicenceExpiryDate]
				  ,[CreatedDate]
				  ,[ModifiedDate]
				  ,[CreatedBy]
				  ,[ModifiedBy]
				  ,[IsActive]
				  ,[CountryId]
				  ,[Occupation]
				  ,[SalaryCycle]
				  ,[NoOfEmployees]
				  ,[WebsiteOfEmployer]
				  ,[PhyAdd1]
				  ,[PhyAdd2]
				  ,[PhyAdd3]
				  ,[PhyAdd4]
				  ,[Code]
				  ,[NatureOfBusiness]
				  ,[EmploymentCategoryId]
				  ,[SectorId]
				  ,[MODRank]
				  ,[PreviousEmployerAddress]
				  ,[PreviousEmployerTelephoneNumberCode]
				  ,[PreviousEmployerTelephoneNumber]
				  ,[CurrentEmployerDateOfEstablishment]
				  ,[OccupationLevelId]
				  ,[DesignationId]
			FROM #temp_table_LinkedTransactionEmploymentToAdd1

		END

	  
/*-------------------- Transaction Employer Ends ----------------------------*/


/*-------------------- Transaction Accounts Starts ----------------------------*/

	IF OBJECT_ID('tempdb..#temp_table_LinkedTransactionBankingDetailsToUpdate') IS NOT NULL
    DROP TABLE #temp_table_LinkedTransactionBankingDetailsToUpdate

	IF OBJECT_ID('tempdb..#temp_table_LinkedTransactionBankingDetailsToAdd') IS NOT NULL
    DROP TABLE #temp_table_LinkedTransactionBankingDetailsToAdd

	IF OBJECT_ID('tempdb..#temp_table_LinkedTransactionBankingDetailsToAdd1') IS NOT NULL
    DROP TABLE #temp_table_LinkedTransactionBankingDetailsToAdd1
		
    -------------------   Accounts To Update -------------------------------		
	Select  
	   P.[Id] 	  
	  ,P.[TransactionId]
      ,TC.[BankId]
      ,TC.[BranchName]
      ,TC.[AccountType]
      ,TC.[AccountNo]
      ,TC.[LoanType]
      ,TC.[IsSalaryTransferedToBank]
      ,TC.[LoanOutstanding]
      ,TC.[Emirate]
      ,TC.[NoOfYearsAccountHeld]
      ,GETUTCDATE() as [ModifiedDate]    
      ,@UserId as [ModifiedBy]
      ,TC.[CountryId]
      ,TC.[BranchCode]
      ,TC.[BranchType]
      ,TC.[NameOfAccountHolder]
      ,TC.[DateOfAccountOpened]      
      ,TC.[MonthlyInstalment]
      ,TC.[CreditCardTypeId]
      ,TC.[CreditCardNumber]
      ,TC.[CreditCardDateofIssue]
      ,TC.[CreditCardDateofExpiry]
      ,TC.[AccountDetailsType]
      ,TC.[IsIncludeDetails]
      ,TC.[DebitOrderDate]
      ,TC.[IsSendDebitOrderDetails]
      ,TC.[DebitOrderStartDate]
      ,TC.[DebitOrderEndDate]
      ,TC.[NoOfPaymentPeriods]
      ,TC.[DebitAmount]
      ,TC.[MaximumAmount]
      ,TC.[DebitOrderCompanyID]
      ,TC.[IsDebitOrder]
      ,TC.[CreditCardOutStanding]
      ,TC.[FirstEMIDate]
      ,TC.[PaymentMethod]
      ,TC.[AccountName]
      ,TC.[IBANNumber]
      ,TC.[NoOfEMIsForObligation]
      ,TC.[RepaymentAccount]
      ,TC.[IsExistingCASAAccountNumber]
      ,TC.[ExistingCASAAccountNumber]
      ,TC.[IsDownPaymentAccount]
      ,TC.[BranchId]
      ,TC.[IsFeeCollectionbyDebitOrder]
      ,TC.[SalaryPayDate]
	  ,TC.Id as OldID
	INTO #temp_table_LinkedTransactionBankingDetailsToUpdate
	FROM [TransactionBankingDetails] TC 
	CROSS JOIN [TransactionBankingDetails] P 
	INNER JOIN #temp_table_LinkedTransactions LT 
	ON P.[TransactionId] = LT.[Id] 
	WHERE TC.[TransactionId] = @TransactionId AND TC.isActive=1 AND P.isActive=1 
	AND ((P.[BankId] = TC.[BankId] AND P.[AccountDetailsType] = TC.[AccountDetailsType]))
	AND TC.isActive=1 AND P.isActive=1
   -- Select * from #temp_table_LinkedTransactionBankingDetailsToUpdate	  
		
	----- BULK UPDATE  
	UPDATE TC 
	  SET   
	   TC.[BankId] =LT.[BankId]
      ,TC.[BranchName]= LT.[BranchName]
      ,TC.[AccountType]= LT.[AccountType]
      ,TC.[AccountNo]= LT.[AccountNo]
      ,TC.[LoanType]= LT.[LoanType]
      ,TC.[IsSalaryTransferedToBank]= LT.[IsSalaryTransferedToBank]
      ,TC.[LoanOutstanding]= LT.[LoanOutstanding]
      ,TC.[Emirate]= LT.[Emirate]
      ,TC.[NoOfYearsAccountHeld]= LT.[NoOfYearsAccountHeld]
      ,TC.[ModifiedDate] =LT.[ModifiedDate]    
      ,TC.[ModifiedBy]=LT.[ModifiedBy]
      ,TC.[CountryId]= LT.[CountryId]
      ,TC.[BranchCode]= LT.[BranchCode]
      ,TC.[BranchType]= LT.[BranchType]
      ,TC.[NameOfAccountHolder]= LT.[NameOfAccountHolder]
      ,TC.[DateOfAccountOpened] = LT.[DateOfAccountOpened]      
      ,TC.[MonthlyInstalment]= LT.[MonthlyInstalment]
      ,TC.[CreditCardTypeId]= LT.[CreditCardTypeId]
      ,TC.[CreditCardNumber]= LT.[CreditCardNumber]
      ,TC.[CreditCardDateofIssue]= LT.[CreditCardDateofIssue]
      ,TC.[CreditCardDateofExpiry]= LT.[CreditCardDateofExpiry]
      ,TC.[AccountDetailsType]= LT.[AccountDetailsType]
      ,TC.[IsIncludeDetails]= LT.[IsIncludeDetails]
      ,TC.[DebitOrderDate]= LT.[DebitOrderDate]
      ,TC.[IsSendDebitOrderDetails]= LT.[IsSendDebitOrderDetails]
      ,TC.[DebitOrderStartDate]= LT.[DebitOrderStartDate]
      ,TC.[DebitOrderEndDate]= LT.[DebitOrderEndDate]
      ,TC.[NoOfPaymentPeriods]= LT.[NoOfPaymentPeriods]
      ,TC.[DebitAmount]= LT.[DebitAmount]
      ,TC.[MaximumAmount]= LT.[MaximumAmount]
      ,TC.[DebitOrderCompanyID]= LT.[DebitOrderCompanyID]
      ,TC.[IsDebitOrder]= LT.[IsDebitOrder]
      ,TC.[CreditCardOutStanding]= LT.[CreditCardOutStanding]
      ,TC.[FirstEMIDate]= LT.[FirstEMIDate]
      ,TC.[PaymentMethod]= LT.[PaymentMethod]
      ,TC.[AccountName]= LT.[AccountName]
      ,TC.[IBANNumber]= LT.[IBANNumber]
      ,TC.[NoOfEMIsForObligation]= LT.[NoOfEMIsForObligation]
      ,TC.[RepaymentAccount]= LT.[RepaymentAccount]
      ,TC.[IsExistingCASAAccountNumber]= LT.[IsExistingCASAAccountNumber]
      ,TC.[ExistingCASAAccountNumber]= LT.[ExistingCASAAccountNumber]
      ,TC.[IsDownPaymentAccount]= LT.[IsDownPaymentAccount]
      ,TC.[BranchId]= LT.[BranchId]
      ,TC.[IsFeeCollectionbyDebitOrder]= LT.[IsFeeCollectionbyDebitOrder]
      ,TC.[SalaryPayDate]= LT.[SalaryPayDate]
	FROM #temp_table_LinkedTransactionBankingDetailsToUpdate AS LT
	INNER JOIN [TransactionBankingDetails] TC 
	ON TC.[Id] = LT.[Id]	  
	
	  --Select * FROM [TransactionBankingDetails] AS TC
	  --INNER JOIN #temp_table_LinkedTransactions AS LT
	  --ON TC.[TransactionId] = LT.[Id]
	  ----print('test point 5')   
	 	   
	-------------------   Accounts To Add	 -------------------------------		
	Declare	@AccountUpdateCount [bigint] 
	SET @AccountUpdateCount = (Select Count(1) FROM #temp_table_LinkedTransactionBankingDetailsToUpdate )
	--print( '@AccountUpdateCount')
	--print( @AccountUpdateCount)
	IF  @AccountUpdateCount > 0
	BEGIN 
		
		Select  
	   0 as [Id]
	  ,LT.[Id] as [TransactionId]
      ,TC.[BankId]
      ,TC.[BranchName]
      ,TC.[AccountType]
      ,TC.[AccountNo]
      ,TC.[LoanType]
      ,TC.[IsSalaryTransferedToBank]
      ,TC.[LoanOutstanding]
      ,TC.[Emirate]
      ,TC.[NoOfYearsAccountHeld]     
      ,TC.[IsActive]
      ,GETUTCDATE() as [CreatedDate]
      ,GETUTCDATE() as [ModifiedDate]
      ,@UserId as [CreatedBy]
      ,@UserId as [ModifiedBy]
      ,TC.[CountryId]
      ,TC.[BranchCode]
      ,TC.[BranchType]
      ,TC.[NameOfAccountHolder]
      ,TC.[DateOfAccountOpened]      
      ,TC.[MonthlyInstalment]
      ,TC.[CreditCardTypeId]
      ,TC.[CreditCardNumber]
      ,TC.[CreditCardDateofIssue]
      ,TC.[CreditCardDateofExpiry]
      ,TC.[AccountDetailsType]
      ,TC.[IsIncludeDetails]
      ,TC.[DebitOrderDate]
      ,TC.[IsSendDebitOrderDetails]
      ,TC.[DebitOrderStartDate]
      ,TC.[DebitOrderEndDate]
      ,TC.[NoOfPaymentPeriods]
      ,TC.[DebitAmount]
      ,TC.[MaximumAmount]
      ,TC.[DebitOrderCompanyID]
      ,TC.[IsDebitOrder]
      ,TC.[CreditCardOutStanding]
      ,TC.[FirstEMIDate]
      ,TC.[PaymentMethod]
      ,TC.[AccountName]
      ,TC.[IBANNumber]
      ,TC.[NoOfEMIsForObligation]
      ,TC.[RepaymentAccount]
      ,TC.[IsExistingCASAAccountNumber]
      ,TC.[ExistingCASAAccountNumber]
      ,TC.[IsDownPaymentAccount]
      ,TC.[BranchId]
      ,TC.[IsFeeCollectionbyDebitOrder]
      ,TC.[SalaryPayDate]
	INTO #temp_table_LinkedTransactionBankingDetailsToAdd1
	FROM [TransactionBankingDetails] TC 		 
	--INNER JOIN #temp_table_LinkedTransactionBankingDetailsToUpdate CTT ON TC.[Id] <> CTT.[OldID] 
	CROSS JOIN #temp_table_LinkedTransactions LT
	where TC.[TransactionId] = @TransactionId 

	--Select *  FROM #temp_table_LinkedTransactionBankingDetailsToAdd1 TC
	--WHERE NOT EXISTS
	--(  (Select CTT.* from #temp_table_LinkedTransactionBankingDetailsToUpdate CTT where 
	--TC.[TransactionId] = CTT.[TransactionId]  
	--AND TC.[BankId] = CTT.[BankId] ANd  TC.[AccountDetailsType] = CTT.[AccountDetailsType])
	--)	

	 --BULK INSERT INTO THE TABLE	
	 INSERT INTO [dbo].[TransactionBankingDetails]
    (
	   [TransactionId]
      ,[BankId]
      ,[BranchName]
      ,[AccountType]
      ,[AccountNo]
      ,[LoanType]
      ,[IsSalaryTransferedToBank]
      ,[LoanOutstanding]
      ,[Emirate]
      ,[NoOfYearsAccountHeld]
      ,[IsActive]
      ,[CreatedDate]
      ,[ModifiedDate]
      ,[CreatedBy]
      ,[ModifiedBy]
      ,[CountryId]
      ,[BranchCode]
      ,[BranchType]
      ,[NameOfAccountHolder]
      ,[DateOfAccountOpened]      
      ,[MonthlyInstalment]
      ,[CreditCardTypeId]
      ,[CreditCardNumber]
      ,[CreditCardDateofIssue]
      ,[CreditCardDateofExpiry]
      ,[AccountDetailsType]
      ,[IsIncludeDetails]
      ,[DebitOrderDate]
      ,[IsSendDebitOrderDetails]
      ,[DebitOrderStartDate]
      ,[DebitOrderEndDate]
      ,[NoOfPaymentPeriods]
      ,[DebitAmount]
      ,[MaximumAmount]
      ,[DebitOrderCompanyID]
      ,[IsDebitOrder]
      ,[CreditCardOutStanding]
      ,[FirstEMIDate]
      ,[PaymentMethod]
      ,[AccountName]
      ,[IBANNumber]
      ,[NoOfEMIsForObligation]
      ,[RepaymentAccount]
      ,[IsExistingCASAAccountNumber]
      ,[ExistingCASAAccountNumber]
      ,[IsDownPaymentAccount]
      ,[BranchId]
      ,[IsFeeCollectionbyDebitOrder]
      ,[SalaryPayDate]
	)
	SELECT  
	   [TransactionId]
      ,TC.[BankId]
      ,TC.[BranchName]
      ,TC.[AccountType]
      ,TC.[AccountNo]
      ,TC.[LoanType]
      ,TC.[IsSalaryTransferedToBank]
      ,TC.[LoanOutstanding]
      ,TC.[Emirate]
      ,TC.[NoOfYearsAccountHeld]
      ,TC.[IsActive]
      ,TC.[CreatedDate]
      ,TC.[ModifiedDate]
      ,TC.[CreatedBy]
      ,TC.[ModifiedBy]
      ,TC.[CountryId]
      ,TC.[BranchCode]
      ,TC.[BranchType]
      ,TC.[NameOfAccountHolder]
      ,TC.[DateOfAccountOpened]      
      ,TC.[MonthlyInstalment]
      ,TC.[CreditCardTypeId]
      ,TC.[CreditCardNumber]
      ,TC.[CreditCardDateofIssue]
      ,TC.[CreditCardDateofExpiry]
      ,TC.[AccountDetailsType]
      ,TC.[IsIncludeDetails]
      ,TC.[DebitOrderDate]
      ,TC.[IsSendDebitOrderDetails]
      ,TC.[DebitOrderStartDate]
      ,TC.[DebitOrderEndDate]
      ,TC.[NoOfPaymentPeriods]
      ,TC.[DebitAmount]
      ,TC.[MaximumAmount]
      ,TC.[DebitOrderCompanyID]
      ,TC.[IsDebitOrder]
      ,TC.[CreditCardOutStanding]
      ,TC.[FirstEMIDate]
      ,TC.[PaymentMethod]
      ,TC.[AccountName]
      ,TC.[IBANNumber]
      ,TC.[NoOfEMIsForObligation]
      ,TC.[RepaymentAccount]
      ,TC.[IsExistingCASAAccountNumber]
      ,TC.[ExistingCASAAccountNumber]
      ,TC.[IsDownPaymentAccount]
      ,TC.[BranchId]
      ,TC.[IsFeeCollectionbyDebitOrder]
      ,TC.[SalaryPayDate]
    FROM #temp_table_LinkedTransactionBankingDetailsToAdd1 TC
	WHERE NOT EXISTS
	(  (Select CTT.* from #temp_table_LinkedTransactionBankingDetailsToUpdate CTT where 
	TC.[TransactionId] = CTT.[TransactionId]  
	AND TC.[BankId] = CTT.[BankId] ANd  TC.[AccountDetailsType] = CTT.[AccountDetailsType])
	)	

	END
	ELSE BEGIN

	--print('in add Accpunts')
		Select  
	   0 as [Id]
	  ,LT.[Id] as [TransactionId]
      ,TC.[BankId]
      ,TC.[BranchName]
      ,TC.[AccountType]
      ,TC.[AccountNo]
      ,TC.[LoanType]
      ,TC.[IsSalaryTransferedToBank]
      ,TC.[LoanOutstanding]
      ,TC.[Emirate]
      ,TC.[NoOfYearsAccountHeld]     
      ,TC.[IsActive]
      ,GETUTCDATE() as [CreatedDate]
      ,GETUTCDATE() as [ModifiedDate]
      ,@UserId as [CreatedBy]
      ,@UserId as [ModifiedBy]
      ,TC.[CountryId]
      ,TC.[BranchCode]
      ,TC.[BranchType]
      ,TC.[NameOfAccountHolder]
      ,TC.[DateOfAccountOpened]      
      ,TC.[MonthlyInstalment]
      ,TC.[CreditCardTypeId]
      ,TC.[CreditCardNumber]
      ,TC.[CreditCardDateofIssue]
      ,TC.[CreditCardDateofExpiry]
      ,TC.[AccountDetailsType]
      ,TC.[IsIncludeDetails]
      ,TC.[DebitOrderDate]
      ,TC.[IsSendDebitOrderDetails]
      ,TC.[DebitOrderStartDate]
      ,TC.[DebitOrderEndDate]
      ,TC.[NoOfPaymentPeriods]
      ,TC.[DebitAmount]
      ,TC.[MaximumAmount]
      ,TC.[DebitOrderCompanyID]
      ,TC.[IsDebitOrder]
      ,TC.[CreditCardOutStanding]
      ,TC.[FirstEMIDate]
      ,TC.[PaymentMethod]
      ,TC.[AccountName]
      ,TC.[IBANNumber]
      ,TC.[NoOfEMIsForObligation]
      ,TC.[RepaymentAccount]
      ,TC.[IsExistingCASAAccountNumber]
      ,TC.[ExistingCASAAccountNumber]
      ,TC.[IsDownPaymentAccount]
      ,TC.[BranchId]
      ,TC.[IsFeeCollectionbyDebitOrder]
      ,TC.[SalaryPayDate]
	INTO #temp_table_LinkedTransactionBankingDetailsToAdd
	FROM [TransactionBankingDetails] TC 		 
	CROSS JOIN #temp_table_LinkedTransactions LT
	where TC.[TransactionId] = @TransactionId 


	Select *  FROM #temp_table_LinkedTransactionBankingDetailsToAdd
    --BULK INSERT INTO THE TABLE	
	INSERT INTO [dbo].[TransactionBankingDetails]
    (
	   [TransactionId]
      ,[BankId]
      ,[BranchName]
      ,[AccountType]
      ,[AccountNo]
      ,[LoanType]
      ,[IsSalaryTransferedToBank]
      ,[LoanOutstanding]
      ,[Emirate]
      ,[NoOfYearsAccountHeld]
      ,[IsActive]
      ,[CreatedDate]
      ,[ModifiedDate]
      ,[CreatedBy]
      ,[ModifiedBy]
      ,[CountryId]
      ,[BranchCode]
      ,[BranchType]
      ,[NameOfAccountHolder]
      ,[DateOfAccountOpened]      
      ,[MonthlyInstalment]
      ,[CreditCardTypeId]
      ,[CreditCardNumber]
      ,[CreditCardDateofIssue]
      ,[CreditCardDateofExpiry]
      ,[AccountDetailsType]
      ,[IsIncludeDetails]
      ,[DebitOrderDate]
      ,[IsSendDebitOrderDetails]
      ,[DebitOrderStartDate]
      ,[DebitOrderEndDate]
      ,[NoOfPaymentPeriods]
      ,[DebitAmount]
      ,[MaximumAmount]
      ,[DebitOrderCompanyID]
      ,[IsDebitOrder]
      ,[CreditCardOutStanding]
      ,[FirstEMIDate]
      ,[PaymentMethod]
      ,[AccountName]
      ,[IBANNumber]
      ,[NoOfEMIsForObligation]
      ,[RepaymentAccount]
      ,[IsExistingCASAAccountNumber]
      ,[ExistingCASAAccountNumber]
      ,[IsDownPaymentAccount]
      ,[BranchId]
      ,[IsFeeCollectionbyDebitOrder]
      ,[SalaryPayDate]
	)
	SELECT  
	   [TransactionId]
      ,[BankId]
      ,[BranchName]
      ,[AccountType]
      ,[AccountNo]
      ,[LoanType]
      ,[IsSalaryTransferedToBank]
      ,[LoanOutstanding]
      ,[Emirate]
      ,[NoOfYearsAccountHeld]
      ,[IsActive]
      ,[CreatedDate]
      ,[ModifiedDate]
      ,[CreatedBy]
      ,[ModifiedBy]
      ,[CountryId]
      ,[BranchCode]
      ,[BranchType]
      ,[NameOfAccountHolder]
      ,[DateOfAccountOpened]      
      ,[MonthlyInstalment]
      ,[CreditCardTypeId]
      ,[CreditCardNumber]
      ,[CreditCardDateofIssue]
      ,[CreditCardDateofExpiry]
      ,[AccountDetailsType]
      ,[IsIncludeDetails]
      ,[DebitOrderDate]
      ,[IsSendDebitOrderDetails]
      ,[DebitOrderStartDate]
      ,[DebitOrderEndDate]
      ,[NoOfPaymentPeriods]
      ,[DebitAmount]
      ,[MaximumAmount]
      ,[DebitOrderCompanyID]
      ,[IsDebitOrder]
      ,[CreditCardOutStanding]
      ,[FirstEMIDate]
      ,[PaymentMethod]
      ,[AccountName]
      ,[IBANNumber]
      ,[NoOfEMIsForObligation]
      ,[RepaymentAccount]
      ,[IsExistingCASAAccountNumber]
      ,[ExistingCASAAccountNumber]
      ,[IsDownPaymentAccount]
      ,[BranchId]
      ,[IsFeeCollectionbyDebitOrder]
      ,[SalaryPayDate]
    FROM #temp_table_LinkedTransactionBankingDetailsToAdd 
	
	END
		
/*-------------------- Transaction Accounts Ends ----------------------------*/


/*-------------------- Income & Expenditure Starts ----------------------------*/

	IF OBJECT_ID('tempdb..#temp_table_LinkedTransactionIncomeAndExpenditureToUpdate') IS NOT NULL
    DROP TABLE #temp_table_LinkedTransactionIncomeAndExpenditureToUpdate

	IF OBJECT_ID('tempdb..#temp_table_LinkedTransactionIncomeAndExpenditureToAdd') IS NOT NULL
    DROP TABLE #temp_table_LinkedTransactionIncomeAndExpenditureToAdd

	IF OBJECT_ID('tempdb..#temp_table_LinkedTransactionIncomeAndExpenditureToAdd1') IS NOT NULL
    DROP TABLE #temp_table_LinkedTransactionIncomeAndExpenditureToAdd1
		
    -------------------   Income & Expenditure To Update -------------------------------		
	Select  
	   P.[Id] 	  
	  ,P.[TransactionId]     
      ,GETUTCDATE() as [ModifiedDate]    
      ,@UserId as [ModifiedBy]
      ,TC.[MonthlySalary]
      ,TC.[Allowance]
      ,TC.[OtherIncome]     
      ,TC.[CountryId]
      ,TC.[IsActive]
      ,TC.[TotalIncome]
      ,TC.[IsOwnHome]
      ,TC.[BondHolderBank]
      ,TC.[Surburb]
      ,TC.[OutstandingBondAmount]
      ,TC.[RentalValue]
      ,TC.[LandlordName]
      ,TC.[LandlordAddress]
      ,TC.[HowAreYouPaid]
      ,TC.[NonMonetaryBenefits]
      ,TC.[Expenditure]
      ,TC.[Deductions]
      ,TC.[Taxation]
      ,TC.[Pension]
      ,TC.[MedicalAidHospitalPlan]
      ,TC.[LifeAssurancePremuims]
      ,TC.[RetirementAnnuityPremuims]
      ,TC.[BondRepayments]
      ,TC.[WaterElectricty]
      ,TC.[RatesTaxes]
      ,TC.[LoanRepayments]
      ,TC.[CreditCardRepayments]
      ,TC.[InsurancePremiums]
      ,TC.[Household]
      ,TC.[MotorVehicles]
      ,TC.[FurnitureAccounts]
      ,TC.[Groceries]
      ,TC.[SchoolFees]
      ,TC.[ClothingAccounts]
      ,TC.[Transport]
      ,TC.[BudgetedSavings]
      ,TC.[Maintenance]
      ,TC.[DomesticStaff]
      ,TC.[Cellphone]
      ,TC.[Entertainment]
      ,TC.[MNET]
      ,TC.[ArmedResponse]
      ,TC.[Gym]
      ,TC.[TotalExpenditure]
      ,TC.[MonthlyBondInstallment]
      ,TC.[PurchasePrice]
      ,TC.[PurchaseDate]
      ,TC.[PresentMarketValue]
      ,TC.[RegisterdTo]
      ,TC.[StandNumber]
      ,TC.[IsGuarantor]
      ,TC.[GrossMonthlySalary]
      ,TC.[IsDeclaredInsolvent]
      ,TC.[RehabilitationDate]
      ,TC.[IsUnderDebtReview]
      ,TC.[IsGuarantorsDetails]
      ,TC.[GuarantorDetails]
      ,TC.[IsShareholderInCompany]
      ,TC.[ShareholdersDetail]
      ,TC.[IsShareDetailsWithinCompany]
      ,TC.[IsShareDetailsAmongPartner]
      ,TC.[IsReceiveMarketingInfo]
      ,TC.[IsShareDetailsToFinancialInstitute]
      ,TC.[IsDisclosureofPersonalInfo]
      ,TC.[IsDebitOrderInformationAndAuthorization]
      ,TC.[BasicMonthlySalary]
      ,TC.[HomeLoanSubsidy]
      ,TC.[CarAllowance]
      ,TC.[OvertimeAndCommission]
      ,TC.[SalaryDeductions]
      ,TC.[SocialSecurity]
      ,TC.[RentalIncome]
      ,TC.[OtherDescription]
      ,TC.[OverdraftRepayments]
      ,TC.[IsCreditRehabilitation]
      ,TC.[ObtainCustomerBankStatements]
      ,TC.[ObtainCustomerSalaryAdvice]
      ,TC.[IsObtainCreditLifeInsurance]
      ,TC.[OtherIncomeSource]
      ,TC.[OtherAllowance]
      ,TC.[LoanRepayments1]
      ,TC.[LoanRepayments2]
      ,TC.[LoanRepayments3]
      ,TC.[LoanRepayments4]
      ,TC.[LoanProviderId]
      ,TC.[Loan1ProviderId]
      ,TC.[Loan2ProviderId]
      ,TC.[Loan3ProviderId]
      ,TC.[Loan4ProviderId]
      ,TC.[LoanIsSettled]
      ,TC.[Loan1IsSettled]
      ,TC.[Loan2IsSettled]
      ,TC.[Loan3IsSettled]
      ,TC.[Loan4IsSettled]
      ,TC.[OtherExpenses]
      ,TC.[SalaryCertificateExpiryDate]
      ,TC.[SalaryReceivedDate1]
      ,TC.[SalaryReceivedDate2]
      ,TC.[SalaryReceivedDate3]
      ,TC.[OwnerShipTypeId]
      ,TC.[InWhoseName]
      ,TC.[FrequencyId]
	  ,TC.Id as OldID
	INTO #temp_table_LinkedTransactionIncomeAndExpenditureToUpdate
	FROM [TransactionIncomeAndExpenditure] TC 
	CROSS JOIN [TransactionIncomeAndExpenditure] P 
	INNER JOIN #temp_table_LinkedTransactions LT 
	ON P.[TransactionId] = LT.[Id] 
	WHERE TC.[TransactionId] = @TransactionId 
	AND ((P.[IsGuarantor] = TC.[IsGuarantor]))
	AND TC.isActive=1 AND P.isActive=1

   --Select * from #temp_table_LinkedTransactionIncomeAndExpenditureToUpdate	  
		
	----- BULK UPDATE  
	UPDATE TC 
	  SET 
      TC.[ModifiedDate] =LT.[ModifiedDate]    
      ,TC.[ModifiedBy]=LT.[ModifiedBy]
      ,TC.[MonthlySalary] =LT.[MonthlySalary]
      ,TC.[Allowance]=LT.[Allowance]
      ,TC.[OtherIncome]=LT.[OtherIncome]    
      ,TC.[CountryId]=LT.[CountryId]
      ,TC.[IsActive]=LT.[IsActive]
      ,TC.[TotalIncome]=LT.[TotalIncome]
      ,TC.[IsOwnHome]=LT.[IsOwnHome]
      ,TC.[BondHolderBank]=LT.[BondHolderBank]
      ,TC.[Surburb]=LT.[Surburb]
      ,TC.[OutstandingBondAmount]=LT.[OutstandingBondAmount]
      ,TC.[RentalValue]=LT.[RentalValue]
      ,TC.[LandlordName]=LT.[LandlordName]
      ,TC.[LandlordAddress]=LT.[LandlordAddress]
      ,TC.[HowAreYouPaid]=LT.[HowAreYouPaid]
      ,TC.[NonMonetaryBenefits]=LT.[NonMonetaryBenefits]
      ,TC.[Expenditure]=LT.[Expenditure]
      ,TC.[Deductions]=LT.[Deductions]
      ,TC.[Taxation]=LT.[Taxation]
      ,TC.[Pension]=LT.[Pension]
      ,TC.[MedicalAidHospitalPlan]=LT.[MedicalAidHospitalPlan]
      ,TC.[LifeAssurancePremuims]=LT.[LifeAssurancePremuims]
      ,TC.[RetirementAnnuityPremuims]=LT.[RetirementAnnuityPremuims]
      ,TC.[BondRepayments]=LT.[BondRepayments]
      ,TC.[WaterElectricty]=LT.[WaterElectricty]
      ,TC.[RatesTaxes]=LT.[RatesTaxes]
      ,TC.[LoanRepayments]=LT.[LoanRepayments]
      ,TC.[CreditCardRepayments]=LT.[CreditCardRepayments]
      ,TC.[InsurancePremiums]=LT.[InsurancePremiums]
      ,TC.[Household]=LT.[Household]
      ,TC.[MotorVehicles]=LT.[MotorVehicles]
      ,TC.[FurnitureAccounts]=LT.[FurnitureAccounts]
      ,TC.[Groceries]=LT.[Groceries]
      ,TC.[SchoolFees]=LT.[SchoolFees]
      ,TC.[ClothingAccounts]=LT.[ClothingAccounts]
      ,TC.[Transport]=LT.[Transport]
      ,TC.[BudgetedSavings]=LT.[BudgetedSavings]
      ,TC.[Maintenance]=LT.[Maintenance]
      ,TC.[DomesticStaff]=LT.[DomesticStaff]
      ,TC.[Cellphone]=LT.[Cellphone]
      ,TC.[Entertainment]=LT.[Entertainment]
      ,TC.[MNET]=LT.[MNET]
      ,TC.[ArmedResponse]=LT.[ArmedResponse]
      ,TC.[Gym]=LT.[Gym]
      ,TC.[TotalExpenditure]=LT.[TotalExpenditure]
      ,TC.[MonthlyBondInstallment]=LT.[MonthlyBondInstallment]
      ,TC.[PurchasePrice]=LT.[PurchasePrice]
      ,TC.[PurchaseDate]=LT.[PurchaseDate]
      ,TC.[PresentMarketValue]=LT.[PresentMarketValue]
      ,TC.[RegisterdTo]=LT.[RegisterdTo]
      ,TC.[StandNumber]=LT.[StandNumber]
      ,TC.[IsGuarantor]=LT.[IsGuarantor]
      ,TC.[GrossMonthlySalary]=LT.[GrossMonthlySalary]
      ,TC.[IsDeclaredInsolvent]=LT.[IsDeclaredInsolvent]
      ,TC.[RehabilitationDate]=LT.[RehabilitationDate]
      ,TC.[IsUnderDebtReview]=LT.[IsUnderDebtReview]
      ,TC.[IsGuarantorsDetails]=LT.[IsGuarantorsDetails]
      ,TC.[GuarantorDetails]=LT.[GuarantorDetails]
      ,TC.[IsShareholderInCompany]=LT.[IsShareholderInCompany]
      ,TC.[ShareholdersDetail]=LT.[ShareholdersDetail]
      ,TC.[IsShareDetailsWithinCompany]=LT.[IsShareDetailsWithinCompany]
      ,TC.[IsShareDetailsAmongPartner]=LT.[IsShareDetailsAmongPartner]
      ,TC.[IsReceiveMarketingInfo]=LT.[IsReceiveMarketingInfo]
      ,TC.[IsShareDetailsToFinancialInstitute]=LT.[IsShareDetailsToFinancialInstitute]
      ,TC.[IsDisclosureofPersonalInfo]=LT.[IsDisclosureofPersonalInfo]
      ,TC.[IsDebitOrderInformationAndAuthorization]=LT.[IsDebitOrderInformationAndAuthorization]
      ,TC.[BasicMonthlySalary]=LT.[BasicMonthlySalary]
      ,TC.[HomeLoanSubsidy]=LT.[HomeLoanSubsidy]
      ,TC.[CarAllowance]=LT.[CarAllowance]
      ,TC.[OvertimeAndCommission]=LT.[OvertimeAndCommission]
      ,TC.[SalaryDeductions]=LT.[SalaryDeductions]
      ,TC.[SocialSecurity]=LT.[SocialSecurity]
      ,TC.[RentalIncome]=LT.[RentalIncome]
      ,TC.[OtherDescription]=LT.[OtherDescription]
      ,TC.[OverdraftRepayments]=LT.[OverdraftRepayments]
      ,TC.[IsCreditRehabilitation]=LT.[IsCreditRehabilitation]
      ,TC.[ObtainCustomerBankStatements]=LT.[ObtainCustomerBankStatements]
      ,TC.[ObtainCustomerSalaryAdvice]=LT.[ObtainCustomerSalaryAdvice]
      ,TC.[IsObtainCreditLifeInsurance]=LT.[IsObtainCreditLifeInsurance]
      ,TC.[OtherIncomeSource]=LT.[OtherIncomeSource]
      ,TC.[OtherAllowance]=LT.[OtherAllowance]
      ,TC.[LoanRepayments1]=LT.[LoanRepayments1]
      ,TC.[LoanRepayments2]=LT.[LoanRepayments2]
      ,TC.[LoanRepayments3]=LT.[LoanRepayments3]
      ,TC.[LoanRepayments4]=LT.[LoanRepayments4]
      ,TC.[LoanProviderId]=LT.[LoanProviderId]
      ,TC.[Loan1ProviderId]=LT.[Loan1ProviderId]
      ,TC.[Loan2ProviderId]=LT.[Loan2ProviderId]
      ,TC.[Loan3ProviderId]=LT.[Loan3ProviderId]
      ,TC.[Loan4ProviderId]=LT.[Loan4ProviderId]
      ,TC.[LoanIsSettled]=LT.[LoanIsSettled]
      ,TC.[Loan1IsSettled]=LT.[Loan1IsSettled]
      ,TC.[Loan2IsSettled]=LT.[Loan2IsSettled]
      ,TC.[Loan3IsSettled]=LT.[Loan3IsSettled]
      ,TC.[Loan4IsSettled]=LT.[Loan4IsSettled]
      ,TC.[OtherExpenses]=LT.[OtherExpenses]
      ,TC.[SalaryCertificateExpiryDate]=LT.[SalaryCertificateExpiryDate]
      ,TC.[SalaryReceivedDate1]=LT.[SalaryReceivedDate1]
      ,TC.[SalaryReceivedDate2]=LT.[SalaryReceivedDate2]
      ,TC.[SalaryReceivedDate3]=LT.[SalaryReceivedDate3]
      ,TC.[OwnerShipTypeId]=LT.[OwnerShipTypeId]
      ,TC.[InWhoseName]=LT.[InWhoseName]
      ,TC.[FrequencyId]=LT.[FrequencyId]
	FROM #temp_table_LinkedTransactionIncomeAndExpenditureToUpdate AS LT
	INNER JOIN [TransactionIncomeAndExpenditure] TC 
	ON TC.[Id] = LT.[Id]	  
	
	  --Select * FROM [TransactionIncomeAndExpenditure] AS TC
	  --INNER JOIN #temp_table_LinkedTransactions AS LT
	  --ON TC.[TransactionId] = LT.[Id]
	  ----print('test point 5')   
	 	   
	-------------------   Income & Expenditure To Add	 -------------------------------		
	Declare	@IncomeExpendUpdateCount [bigint] 
	SET @IncomeExpendUpdateCount = (Select Count(1) FROM #temp_table_LinkedTransactionIncomeAndExpenditureToUpdate )
		
	IF  @IncomeExpendUpdateCount > 0
	BEGIN 
		--Print('@IncomeExpendUpdateCount: ')
		--Select @IncomeExpendUpdateCount

		Select  
	   0 as [Id]
	  ,LT.[Id] as [TransactionId]
      ,TC.[MonthlySalary]
      ,TC.[Allowance]
      ,TC.[OtherIncome]  
      ,TC.[IsActive]
      ,GETUTCDATE() as [CreatedDate]
      ,GETUTCDATE() as [ModifiedDate]
      ,@UserId as [CreatedBy]
      ,@UserId as [ModifiedBy]
      ,TC.[CountryId]
      ,TC.[TotalIncome]
      ,TC.[IsOwnHome]
      ,TC.[BondHolderBank]
      ,TC.[Surburb]
      ,TC.[OutstandingBondAmount]
      ,TC.[RentalValue]
      ,TC.[LandlordName]
      ,TC.[LandlordAddress]
      ,TC.[HowAreYouPaid]
      ,TC.[NonMonetaryBenefits]
      ,TC.[Expenditure]
      ,TC.[Deductions]
      ,TC.[Taxation]
      ,TC.[Pension]
      ,TC.[MedicalAidHospitalPlan]
      ,TC.[LifeAssurancePremuims]
      ,TC.[RetirementAnnuityPremuims]
      ,TC.[BondRepayments]
      ,TC.[WaterElectricty]
      ,TC.[RatesTaxes]
      ,TC.[LoanRepayments]
      ,TC.[CreditCardRepayments]
      ,TC.[InsurancePremiums]
      ,TC.[Household]
      ,TC.[MotorVehicles]
      ,TC.[FurnitureAccounts]
      ,TC.[Groceries]
      ,TC.[SchoolFees]
      ,TC.[ClothingAccounts]
      ,TC.[Transport]
      ,TC.[BudgetedSavings]
      ,TC.[Maintenance]
      ,TC.[DomesticStaff]
      ,TC.[Cellphone]
      ,TC.[Entertainment]
      ,TC.[MNET]
      ,TC.[ArmedResponse]
      ,TC.[Gym]
      ,TC.[TotalExpenditure]
      ,TC.[MonthlyBondInstallment]
      ,TC.[PurchasePrice]
      ,TC.[PurchaseDate]
      ,TC.[PresentMarketValue]
      ,TC.[RegisterdTo]
      ,TC.[StandNumber]
      ,TC.[IsGuarantor]
      ,TC.[GrossMonthlySalary]
      ,TC.[IsDeclaredInsolvent]
      ,TC.[RehabilitationDate]
      ,TC.[IsUnderDebtReview]
      ,TC.[IsGuarantorsDetails]
      ,TC.[GuarantorDetails]
      ,TC.[IsShareholderInCompany]
      ,TC.[ShareholdersDetail]
      ,TC.[IsShareDetailsWithinCompany]
      ,TC.[IsShareDetailsAmongPartner]
      ,TC.[IsReceiveMarketingInfo]
      ,TC.[IsShareDetailsToFinancialInstitute]
      ,TC.[IsDisclosureofPersonalInfo]
      ,TC.[IsDebitOrderInformationAndAuthorization]
      ,TC.[BasicMonthlySalary]
      ,TC.[HomeLoanSubsidy]
      ,TC.[CarAllowance]
      ,TC.[OvertimeAndCommission]
      ,TC.[SalaryDeductions]
      ,TC.[SocialSecurity]
      ,TC.[RentalIncome]
      ,TC.[OtherDescription]
      ,TC.[OverdraftRepayments]
      ,TC.[IsCreditRehabilitation]
      ,TC.[ObtainCustomerBankStatements]
      ,TC.[ObtainCustomerSalaryAdvice]
      ,TC.[IsObtainCreditLifeInsurance]
      ,TC.[OtherIncomeSource]
      ,TC.[OtherAllowance]
      ,TC.[LoanRepayments1]
      ,TC.[LoanRepayments2]
      ,TC.[LoanRepayments3]
      ,TC.[LoanRepayments4]
      ,TC.[LoanProviderId]
      ,TC.[Loan1ProviderId]
      ,TC.[Loan2ProviderId]
      ,TC.[Loan3ProviderId]
      ,TC.[Loan4ProviderId]
      ,TC.[LoanIsSettled]
      ,TC.[Loan1IsSettled]
      ,TC.[Loan2IsSettled]
      ,TC.[Loan3IsSettled]
      ,TC.[Loan4IsSettled]
      ,TC.[OtherExpenses]
      ,TC.[SalaryCertificateExpiryDate]
      ,TC.[SalaryReceivedDate1]
      ,TC.[SalaryReceivedDate2]
      ,TC.[SalaryReceivedDate3]
      ,TC.[OwnerShipTypeId]
      ,TC.[InWhoseName]
      ,TC.[FrequencyId]
	  ,TC.Id as TCOLDID
	INTO #temp_table_LinkedTransactionIncomeAndExpenditureToAdd1
	FROM [TransactionIncomeAndExpenditure] TC 		 
	CROSS JOIN #temp_table_LinkedTransactions LT
	where TC.[TransactionId] = @TransactionId 

	--Select TC.*  FROM #temp_table_LinkedTransactionIncomeAndExpenditureToAdd1 TC
	--WHERE NOT EXISTS
	--(  (Select CTT.* from #temp_table_LinkedTransactionIncomeAndExpenditureToUpdate CTT where 
	--TC.[TransactionId] = CTT.[TransactionId]  AND TC.[IsGuarantor] = CTT.[IsGuarantor])
	--)
	
		
		--BULK INSERT INTO THE TABLE	
		INSERT INTO [dbo].[TransactionIncomeAndExpenditure]
    (
	   [TransactionId]
      ,[MonthlySalary]
      ,[Allowance]
      ,[OtherIncome]
      ,[CreatedDate]
      ,[ModifiedDate]
      ,[CreatedBy]
      ,[ModifiedBy]
      ,[CountryId]
      ,[IsActive]
      ,[TotalIncome]
      ,[IsOwnHome]
      ,[BondHolderBank]
      ,[Surburb]
      ,[OutstandingBondAmount]
      ,[RentalValue]
      ,[LandlordName]
      ,[LandlordAddress]
      ,[HowAreYouPaid]
      ,[NonMonetaryBenefits]
      ,[Expenditure]
      ,[Deductions]
      ,[Taxation]
      ,[Pension]
      ,[MedicalAidHospitalPlan]
      ,[LifeAssurancePremuims]
      ,[RetirementAnnuityPremuims]
      ,[BondRepayments]
      ,[WaterElectricty]
      ,[RatesTaxes]
      ,[LoanRepayments]
      ,[CreditCardRepayments]
      ,[InsurancePremiums]
      ,[Household]
      ,[MotorVehicles]
      ,[FurnitureAccounts]
      ,[Groceries]
      ,[SchoolFees]
      ,[ClothingAccounts]
      ,[Transport]
      ,[BudgetedSavings]
      ,[Maintenance]
      ,[DomesticStaff]
      ,[Cellphone]
      ,[Entertainment]
      ,[MNET]
      ,[ArmedResponse]
      ,[Gym]
      ,[TotalExpenditure]
      ,[MonthlyBondInstallment]
      ,[PurchasePrice]
      ,[PurchaseDate]
      ,[PresentMarketValue]
      ,[RegisterdTo]
      ,[StandNumber]
      ,[IsGuarantor]
      ,[GrossMonthlySalary]
      ,[IsDeclaredInsolvent]
      ,[RehabilitationDate]
      ,[IsUnderDebtReview]
      ,[IsGuarantorsDetails]
      ,[GuarantorDetails]
      ,[IsShareholderInCompany]
      ,[ShareholdersDetail]
      ,[IsShareDetailsWithinCompany]
      ,[IsShareDetailsAmongPartner]
      ,[IsReceiveMarketingInfo]
      ,[IsShareDetailsToFinancialInstitute]
      ,[IsDisclosureofPersonalInfo]
      ,[IsDebitOrderInformationAndAuthorization]
      ,[BasicMonthlySalary]
      ,[HomeLoanSubsidy]
      ,[CarAllowance]
      ,[OvertimeAndCommission]
      ,[SalaryDeductions]
      ,[SocialSecurity]
      ,[RentalIncome]
      ,[OtherDescription]
      ,[OverdraftRepayments]
      ,[IsCreditRehabilitation]
      ,[ObtainCustomerBankStatements]
      ,[ObtainCustomerSalaryAdvice]
      ,[IsObtainCreditLifeInsurance]
      ,[OtherIncomeSource]
      ,[OtherAllowance]
      ,[LoanRepayments1]
      ,[LoanRepayments2]
      ,[LoanRepayments3]
      ,[LoanRepayments4]
      ,[LoanProviderId]
      ,[Loan1ProviderId]
      ,[Loan2ProviderId]
      ,[Loan3ProviderId]
      ,[Loan4ProviderId]
      ,[LoanIsSettled]
      ,[Loan1IsSettled]
      ,[Loan2IsSettled]
      ,[Loan3IsSettled]
      ,[Loan4IsSettled]
      ,[OtherExpenses]
      ,[SalaryCertificateExpiryDate]
      ,[SalaryReceivedDate1]
      ,[SalaryReceivedDate2]
      ,[SalaryReceivedDate3]
      ,[OwnerShipTypeId]
      ,[InWhoseName]
      ,[FrequencyId]
	)
	SELECT  
	   [TransactionId]
      ,TC.[MonthlySalary]
      ,TC.[Allowance]
      ,TC.[OtherIncome]
      ,TC.[CreatedDate]
      ,TC.[ModifiedDate]
      ,TC.[CreatedBy]
      ,TC.[ModifiedBy]
      ,TC.[CountryId]
      ,TC.[IsActive]
      ,TC.[TotalIncome]
      ,TC.[IsOwnHome]
      ,TC.[BondHolderBank]
      ,TC.[Surburb]
      ,TC.[OutstandingBondAmount]
      ,TC.[RentalValue]
      ,TC.[LandlordName]
      ,TC.[LandlordAddress]
      ,TC.[HowAreYouPaid]
      ,TC.[NonMonetaryBenefits]
      ,TC.[Expenditure]
      ,TC.[Deductions]
      ,TC.[Taxation]
      ,TC.[Pension]
      ,TC.[MedicalAidHospitalPlan]
      ,TC.[LifeAssurancePremuims]
      ,TC.[RetirementAnnuityPremuims]
      ,TC.[BondRepayments]
      ,TC.[WaterElectricty]
      ,TC.[RatesTaxes]
      ,TC.[LoanRepayments]
      ,TC.[CreditCardRepayments]
      ,TC.[InsurancePremiums]
      ,TC.[Household]
      ,TC.[MotorVehicles]
      ,TC.[FurnitureAccounts]
      ,TC.[Groceries]
      ,TC.[SchoolFees]
      ,TC.[ClothingAccounts]
      ,TC.[Transport]
      ,TC.[BudgetedSavings]
      ,TC.[Maintenance]
      ,TC.[DomesticStaff]
      ,TC.[Cellphone]
      ,TC.[Entertainment]
      ,TC.[MNET]
      ,TC.[ArmedResponse]
      ,TC.[Gym]
      ,TC.[TotalExpenditure]
      ,TC.[MonthlyBondInstallment]
      ,TC.[PurchasePrice]
      ,TC.[PurchaseDate]
      ,TC.[PresentMarketValue]
      ,TC.[RegisterdTo]
      ,TC.[StandNumber]
      ,TC.[IsGuarantor]
      ,TC.[GrossMonthlySalary]
      ,TC.[IsDeclaredInsolvent]
      ,TC.[RehabilitationDate]
      ,TC.[IsUnderDebtReview]
      ,TC.[IsGuarantorsDetails]
      ,TC.[GuarantorDetails]
      ,TC.[IsShareholderInCompany]
      ,TC.[ShareholdersDetail]
      ,TC.[IsShareDetailsWithinCompany]
      ,TC.[IsShareDetailsAmongPartner]
      ,TC.[IsReceiveMarketingInfo]
      ,TC.[IsShareDetailsToFinancialInstitute]
      ,TC.[IsDisclosureofPersonalInfo]
      ,TC.[IsDebitOrderInformationAndAuthorization]
      ,TC.[BasicMonthlySalary]
      ,TC.[HomeLoanSubsidy]
      ,TC.[CarAllowance]
      ,TC.[OvertimeAndCommission]
      ,TC.[SalaryDeductions]
      ,TC.[SocialSecurity]
      ,TC.[RentalIncome]
      ,TC.[OtherDescription]
      ,TC.[OverdraftRepayments]
      ,TC.[IsCreditRehabilitation]
      ,TC.[ObtainCustomerBankStatements]
      ,TC.[ObtainCustomerSalaryAdvice]
      ,TC.[IsObtainCreditLifeInsurance]
      ,TC.[OtherIncomeSource]
      ,TC.[OtherAllowance]
      ,TC.[LoanRepayments1]
      ,TC.[LoanRepayments2]
      ,TC.[LoanRepayments3]
      ,TC.[LoanRepayments4]
      ,TC.[LoanProviderId]
      ,TC.[Loan1ProviderId]
      ,TC.[Loan2ProviderId]
      ,TC.[Loan3ProviderId]
      ,TC.[Loan4ProviderId]
      ,TC.[LoanIsSettled]
      ,TC.[Loan1IsSettled]
      ,TC.[Loan2IsSettled]
      ,TC.[Loan3IsSettled]
      ,TC.[Loan4IsSettled]
      ,TC.[OtherExpenses]
      ,TC.[SalaryCertificateExpiryDate]
      ,TC.[SalaryReceivedDate1]
      ,TC.[SalaryReceivedDate2]
      ,TC.[SalaryReceivedDate3]
      ,TC.[OwnerShipTypeId]
      ,TC.[InWhoseName]
      ,TC.[FrequencyId]
    FROM #temp_table_LinkedTransactionIncomeAndExpenditureToAdd1 TC
	WHERE NOT EXISTS
	(  (Select CTT.* from #temp_table_LinkedTransactionIncomeAndExpenditureToUpdate CTT where 
	TC.[TransactionId] = CTT.[TransactionId]  AND TC.[IsGuarantor] = CTT.[IsGuarantor])
	)

	END
	ELSE BEGIN

		Select  
	   0 as [Id]
	  ,LT.[Id] as [TransactionId]
      ,TC.[MonthlySalary]
      ,TC.[Allowance]
      ,TC.[OtherIncome]  
      ,TC.[IsActive]
      ,GETUTCDATE() as [CreatedDate]
      ,GETUTCDATE() as [ModifiedDate]
      ,@UserId as [CreatedBy]
      ,@UserId as [ModifiedBy]
      ,TC.[CountryId]
      ,TC.[TotalIncome]
      ,TC.[IsOwnHome]
      ,TC.[BondHolderBank]
      ,TC.[Surburb]
      ,TC.[OutstandingBondAmount]
      ,TC.[RentalValue]
      ,TC.[LandlordName]
      ,TC.[LandlordAddress]
      ,TC.[HowAreYouPaid]
      ,TC.[NonMonetaryBenefits]
      ,TC.[Expenditure]
      ,TC.[Deductions]
      ,TC.[Taxation]
      ,TC.[Pension]
      ,TC.[MedicalAidHospitalPlan]
      ,TC.[LifeAssurancePremuims]
      ,TC.[RetirementAnnuityPremuims]
      ,TC.[BondRepayments]
      ,TC.[WaterElectricty]
      ,TC.[RatesTaxes]
      ,TC.[LoanRepayments]
      ,TC.[CreditCardRepayments]
      ,TC.[InsurancePremiums]
      ,TC.[Household]
      ,TC.[MotorVehicles]
      ,TC.[FurnitureAccounts]
      ,TC.[Groceries]
      ,TC.[SchoolFees]
      ,TC.[ClothingAccounts]
      ,TC.[Transport]
      ,TC.[BudgetedSavings]
      ,TC.[Maintenance]
      ,TC.[DomesticStaff]
      ,TC.[Cellphone]
      ,TC.[Entertainment]
      ,TC.[MNET]
      ,TC.[ArmedResponse]
      ,TC.[Gym]
      ,TC.[TotalExpenditure]
      ,TC.[MonthlyBondInstallment]
      ,TC.[PurchasePrice]
      ,TC.[PurchaseDate]
      ,TC.[PresentMarketValue]
      ,TC.[RegisterdTo]
      ,TC.[StandNumber]
      ,TC.[IsGuarantor]
      ,TC.[GrossMonthlySalary]
      ,TC.[IsDeclaredInsolvent]
      ,TC.[RehabilitationDate]
      ,TC.[IsUnderDebtReview]
      ,TC.[IsGuarantorsDetails]
      ,TC.[GuarantorDetails]
      ,TC.[IsShareholderInCompany]
      ,TC.[ShareholdersDetail]
      ,TC.[IsShareDetailsWithinCompany]
      ,TC.[IsShareDetailsAmongPartner]
      ,TC.[IsReceiveMarketingInfo]
      ,TC.[IsShareDetailsToFinancialInstitute]
      ,TC.[IsDisclosureofPersonalInfo]
      ,TC.[IsDebitOrderInformationAndAuthorization]
      ,TC.[BasicMonthlySalary]
      ,TC.[HomeLoanSubsidy]
      ,TC.[CarAllowance]
      ,TC.[OvertimeAndCommission]
      ,TC.[SalaryDeductions]
      ,TC.[SocialSecurity]
      ,TC.[RentalIncome]
      ,TC.[OtherDescription]
      ,TC.[OverdraftRepayments]
      ,TC.[IsCreditRehabilitation]
      ,TC.[ObtainCustomerBankStatements]
      ,TC.[ObtainCustomerSalaryAdvice]
      ,TC.[IsObtainCreditLifeInsurance]
      ,TC.[OtherIncomeSource]
      ,TC.[OtherAllowance]
      ,TC.[LoanRepayments1]
      ,TC.[LoanRepayments2]
      ,TC.[LoanRepayments3]
      ,TC.[LoanRepayments4]
      ,TC.[LoanProviderId]
      ,TC.[Loan1ProviderId]
      ,TC.[Loan2ProviderId]
      ,TC.[Loan3ProviderId]
      ,TC.[Loan4ProviderId]
      ,TC.[LoanIsSettled]
      ,TC.[Loan1IsSettled]
      ,TC.[Loan2IsSettled]
      ,TC.[Loan3IsSettled]
      ,TC.[Loan4IsSettled]
      ,TC.[OtherExpenses]
      ,TC.[SalaryCertificateExpiryDate]
      ,TC.[SalaryReceivedDate1]
      ,TC.[SalaryReceivedDate2]
      ,TC.[SalaryReceivedDate3]
      ,TC.[OwnerShipTypeId]
      ,TC.[InWhoseName]
      ,TC.[FrequencyId]
	INTO #temp_table_LinkedTransactionIncomeAndExpenditureToAdd
	FROM [TransactionIncomeAndExpenditure] TC 
	CROSS JOIN #temp_table_LinkedTransactions LT
	where TC.[TransactionId] = @TransactionId 

		--Select *  FROM #temp_table_LinkedTransactionIncomeAndExpenditureToAdd
		--BULK INSERT INTO THE TABLE	
		INSERT INTO [dbo].[TransactionIncomeAndExpenditure]
    (
	   [TransactionId]
      ,[MonthlySalary]
      ,[Allowance]
      ,[OtherIncome]
      ,[CreatedDate]
      ,[ModifiedDate]
      ,[CreatedBy]
      ,[ModifiedBy]
      ,[CountryId]
      ,[IsActive]
      ,[TotalIncome]
      ,[IsOwnHome]
      ,[BondHolderBank]
      ,[Surburb]
      ,[OutstandingBondAmount]
      ,[RentalValue]
      ,[LandlordName]
      ,[LandlordAddress]
      ,[HowAreYouPaid]
      ,[NonMonetaryBenefits]
      ,[Expenditure]
      ,[Deductions]
      ,[Taxation]
      ,[Pension]
      ,[MedicalAidHospitalPlan]
      ,[LifeAssurancePremuims]
      ,[RetirementAnnuityPremuims]
      ,[BondRepayments]
      ,[WaterElectricty]
      ,[RatesTaxes]
      ,[LoanRepayments]
      ,[CreditCardRepayments]
      ,[InsurancePremiums]
      ,[Household]
      ,[MotorVehicles]
      ,[FurnitureAccounts]
      ,[Groceries]
      ,[SchoolFees]
      ,[ClothingAccounts]
      ,[Transport]
      ,[BudgetedSavings]
      ,[Maintenance]
      ,[DomesticStaff]
      ,[Cellphone]
      ,[Entertainment]
      ,[MNET]
      ,[ArmedResponse]
      ,[Gym]
      ,[TotalExpenditure]
      ,[MonthlyBondInstallment]
      ,[PurchasePrice]
      ,[PurchaseDate]
      ,[PresentMarketValue]
      ,[RegisterdTo]
      ,[StandNumber]
      ,[IsGuarantor]
      ,[GrossMonthlySalary]
      ,[IsDeclaredInsolvent]
      ,[RehabilitationDate]
      ,[IsUnderDebtReview]
      ,[IsGuarantorsDetails]
      ,[GuarantorDetails]
      ,[IsShareholderInCompany]
      ,[ShareholdersDetail]
      ,[IsShareDetailsWithinCompany]
      ,[IsShareDetailsAmongPartner]
      ,[IsReceiveMarketingInfo]
      ,[IsShareDetailsToFinancialInstitute]
      ,[IsDisclosureofPersonalInfo]
      ,[IsDebitOrderInformationAndAuthorization]
      ,[BasicMonthlySalary]
      ,[HomeLoanSubsidy]
      ,[CarAllowance]
      ,[OvertimeAndCommission]
      ,[SalaryDeductions]
      ,[SocialSecurity]
      ,[RentalIncome]
      ,[OtherDescription]
      ,[OverdraftRepayments]
      ,[IsCreditRehabilitation]
      ,[ObtainCustomerBankStatements]
      ,[ObtainCustomerSalaryAdvice]
      ,[IsObtainCreditLifeInsurance]
      ,[OtherIncomeSource]
      ,[OtherAllowance]
      ,[LoanRepayments1]
      ,[LoanRepayments2]
      ,[LoanRepayments3]
      ,[LoanRepayments4]
      ,[LoanProviderId]
      ,[Loan1ProviderId]
      ,[Loan2ProviderId]
      ,[Loan3ProviderId]
      ,[Loan4ProviderId]
      ,[LoanIsSettled]
      ,[Loan1IsSettled]
      ,[Loan2IsSettled]
      ,[Loan3IsSettled]
      ,[Loan4IsSettled]
      ,[OtherExpenses]
      ,[SalaryCertificateExpiryDate]
      ,[SalaryReceivedDate1]
      ,[SalaryReceivedDate2]
      ,[SalaryReceivedDate3]
      ,[OwnerShipTypeId]
      ,[InWhoseName]
      ,[FrequencyId]
	)
	SELECT  
	   [TransactionId]
      ,[MonthlySalary]
      ,[Allowance]
      ,[OtherIncome]
      ,[CreatedDate]
      ,[ModifiedDate]
      ,[CreatedBy]
      ,[ModifiedBy]
      ,[CountryId]
      ,[IsActive]
      ,[TotalIncome]
      ,[IsOwnHome]
      ,[BondHolderBank]
      ,[Surburb]
      ,[OutstandingBondAmount]
      ,[RentalValue]
      ,[LandlordName]
      ,[LandlordAddress]
      ,[HowAreYouPaid]
      ,[NonMonetaryBenefits]
      ,[Expenditure]
      ,[Deductions]
      ,[Taxation]
      ,[Pension]
      ,[MedicalAidHospitalPlan]
      ,[LifeAssurancePremuims]
      ,[RetirementAnnuityPremuims]
      ,[BondRepayments]
      ,[WaterElectricty]
      ,[RatesTaxes]
      ,[LoanRepayments]
      ,[CreditCardRepayments]
      ,[InsurancePremiums]
      ,[Household]
      ,[MotorVehicles]
      ,[FurnitureAccounts]
      ,[Groceries]
      ,[SchoolFees]
      ,[ClothingAccounts]
      ,[Transport]
      ,[BudgetedSavings]
      ,[Maintenance]
      ,[DomesticStaff]
      ,[Cellphone]
      ,[Entertainment]
      ,[MNET]
      ,[ArmedResponse]
      ,[Gym]
      ,[TotalExpenditure]
      ,[MonthlyBondInstallment]
      ,[PurchasePrice]
      ,[PurchaseDate]
      ,[PresentMarketValue]
      ,[RegisterdTo]
      ,[StandNumber]
      ,[IsGuarantor]
      ,[GrossMonthlySalary]
      ,[IsDeclaredInsolvent]
      ,[RehabilitationDate]
      ,[IsUnderDebtReview]
      ,[IsGuarantorsDetails]
      ,[GuarantorDetails]
      ,[IsShareholderInCompany]
      ,[ShareholdersDetail]
      ,[IsShareDetailsWithinCompany]
      ,[IsShareDetailsAmongPartner]
      ,[IsReceiveMarketingInfo]
      ,[IsShareDetailsToFinancialInstitute]
      ,[IsDisclosureofPersonalInfo]
      ,[IsDebitOrderInformationAndAuthorization]
      ,[BasicMonthlySalary]
      ,[HomeLoanSubsidy]
      ,[CarAllowance]
      ,[OvertimeAndCommission]
      ,[SalaryDeductions]
      ,[SocialSecurity]
      ,[RentalIncome]
      ,[OtherDescription]
      ,[OverdraftRepayments]
      ,[IsCreditRehabilitation]
      ,[ObtainCustomerBankStatements]
      ,[ObtainCustomerSalaryAdvice]
      ,[IsObtainCreditLifeInsurance]
      ,[OtherIncomeSource]
      ,[OtherAllowance]
      ,[LoanRepayments1]
      ,[LoanRepayments2]
      ,[LoanRepayments3]
      ,[LoanRepayments4]
      ,[LoanProviderId]
      ,[Loan1ProviderId]
      ,[Loan2ProviderId]
      ,[Loan3ProviderId]
      ,[Loan4ProviderId]
      ,[LoanIsSettled]
      ,[Loan1IsSettled]
      ,[Loan2IsSettled]
      ,[Loan3IsSettled]
      ,[Loan4IsSettled]
      ,[OtherExpenses]
      ,[SalaryCertificateExpiryDate]
      ,[SalaryReceivedDate1]
      ,[SalaryReceivedDate2]
      ,[SalaryReceivedDate3]
      ,[OwnerShipTypeId]
      ,[InWhoseName]
      ,[FrequencyId]
    FROM #temp_table_LinkedTransactionIncomeAndExpenditureToAdd
	
	END
		
/*-------------------- Income & Expenditure Ends ----------------------------*/




/*-------------------- Finance Apps Starts ----------------------------*/

	IF OBJECT_ID('tempdb..#temp_table_LinkedFinanceAppsToUpdate') IS NOT NULL
    DROP TABLE #temp_table_LinkedFinanceAppsToUpdate

	IF OBJECT_ID('tempdb..#temp_table_LinkedFinanceAppsToAdd') IS NOT NULL
    DROP TABLE #temp_table_LinkedFinanceAppsToAdd

	IF OBJECT_ID('tempdb..#temp_table_LinkedFinanceAppsToAdd1') IS NOT NULL
    DROP TABLE #temp_table_LinkedFinanceAppsToAdd1
		
    -------   Finance Apps  To Update ---------		
	Select  
	   P.[Id] 	  
	  ,P.[TransactionId]     
      ,GETUTCDATE() as [ModifiedDate]    
      ,@UserId as [ModifiedBy]
      ,TC.[ClientId]
      ,TC.[CompanyId]
	  ,TC.[CountryId]
      ,TC.[CompanyCompanyTypeId]
	  ,TC.Id as OldID
	INTO #temp_table_LinkedFinanceAppsToUpdate
	FROM [TransactionFinanceApplication] TC 
	CROSS JOIN [TransactionFinanceApplication] P 
	INNER JOIN #temp_table_LinkedTransactions LT 
	ON P.[TransactionId] = LT.[Id] 
	WHERE TC.[TransactionId] = @TransactionId 	
	AND TC.isActive=1 AND P.isActive=1

   --Select * from #temp_table_LinkedFinanceAppsToUpdate	  
		
	----- BULK UPDATE  
	UPDATE TC 
	  SET 
       TC.[ModifiedDate] =LT.[ModifiedDate]    
      ,TC.[ModifiedBy]=LT.[ModifiedBy]
      ,TC.[ClientId]= LT.[ClientId]
      ,TC.[CompanyId] = LT.[CompanyId]
	  ,TC.[CountryId] = LT.[CountryId]
      ,TC.[CompanyCompanyTypeId] = LT.[CompanyCompanyTypeId]
	FROM #temp_table_LinkedFinanceAppsToUpdate AS LT
	INNER JOIN [TransactionFinanceApplication] TC 
	ON TC.[Id] = LT.[Id]	  
	
	  --Select * FROM [TransactionFinanceApplication] AS TC
	  --INNER JOIN #temp_table_LinkedTransactions AS LT
	  --ON TC.[TransactionId] = LT.[Id]
	  ----print('test point 5')   
	 	   
	-------------------   Finace App To Add	 -------------------------------		
	Declare	@FinanceAppUpdateCount [bigint] 
	SET @FinanceAppUpdateCount = (Select Count(1) FROM #temp_table_LinkedFinanceAppsToUpdate )
		
	IF  @FinanceAppUpdateCount > 0
	BEGIN 
		--Print('@FinanceAppUpdateCount : ')
		
	Select  
	   0 as [Id]
	  ,LT.[Id] as [TransactionId]
      ,TC.[ClientId]
      ,TC.[CompanyId]
	  ,TC.[CountryId]
      ,TC.[CompanyCompanyTypeId]
      ,GETUTCDATE() as [CreatedDate]
      ,GETUTCDATE() as [ModifiedDate]
      ,@UserId as [CreatedBy]
      ,@UserId as [ModifiedBy]
       ,TC.[isActive]   
	  ,TC.Id as TCOLDID	  
	INTO #temp_table_LinkedFinanceAppsToAdd1
	FROM [TransactionFinanceApplication] TC 		 
	CROSS JOIN #temp_table_LinkedTransactions LT
	where TC.[TransactionId] = @TransactionId 

	--Select TC.*  FROM #temp_table_LinkedFinanceAppsToAdd1 TC
	--WHERE NOT EXISTS
	--(  (Select CTT.* from #temp_table_LinkedFinanceAppsToUpdate CTT where 
	--TC.[TransactionId] = CTT.[TransactionId]  AND TC.[CompanyId] = CTT.[CompanyId])
	--)
	
		
	--BULK INSERT INTO THE TABLE	
	INSERT INTO [dbo].[TransactionFinanceApplication]
    (
	   [TransactionId]
      ,[ClientId]
      ,[CompanyId]
	  ,[CountryId]
      ,[CompanyCompanyTypeId]
      ,[CreatedDate]
      ,[ModifiedDate]
      ,[CreatedBy]
      ,[ModifiedBy]     
      ,[IsActive]     
	)
	SELECT  
	   [TransactionId]
      ,TC.[ClientId]
      ,TC.[CompanyId]
	  ,TC.[CountryId]
      ,TC.[CompanyCompanyTypeId]
      ,TC.[CreatedDate]
      ,TC.[ModifiedDate]
      ,TC.[CreatedBy]
      ,TC.[ModifiedBy]     
      ,TC.[IsActive]     
    FROM #temp_table_LinkedFinanceAppsToAdd1 TC
	WHERE NOT EXISTS
	(  (Select CTT.* from #temp_table_LinkedFinanceAppsToUpdate CTT where 
	TC.[TransactionId] = CTT.[TransactionId]  AND TC.[CompanyId] = CTT.[CompanyId])
	)

	END
	ELSE BEGIN

    Select  
	   0 as [Id]
	  ,LT.[Id] as [TransactionId]
      ,TC.[ClientId]
      ,TC.[CompanyId]
	  ,TC.[CountryId]
      ,TC.[CompanyCompanyTypeId]
      ,TC.[IsActive]
      ,GETUTCDATE() as [CreatedDate]
      ,GETUTCDATE() as [ModifiedDate]
      ,@UserId as [CreatedBy]
      ,@UserId as [ModifiedBy]
      
	INTO #temp_table_LinkedFinanceAppsToAdd
	FROM [TransactionFinanceApplication] TC 
	CROSS JOIN #temp_table_LinkedTransactions LT
	where TC.[TransactionId] = @TransactionId 

	--Select *  FROM #temp_table_LinkedFinanceAppsToAdd

	--BULK INSERT INTO THE TABLE	
	INSERT INTO [dbo].[TransactionFinanceApplication]
    (
	   [TransactionId]
      ,[ClientId]
      ,[CompanyId]
	  ,[CountryId]
      ,[CompanyCompanyTypeId]
      ,[CreatedDate]
      ,[ModifiedDate]
      ,[CreatedBy]
      ,[ModifiedBy]     
      ,[IsActive]     
	)
	SELECT  
	   TC.[TransactionId]
      ,TC.[ClientId]
      ,TC.[CompanyId]
	  ,TC.[CountryId]
      ,TC.[CompanyCompanyTypeId]
      ,TC.[CreatedDate]
      ,TC.[ModifiedDate]
      ,TC.[CreatedBy]
      ,TC.[ModifiedBy]      
      ,TC.[IsActive]     
    FROM #temp_table_LinkedFinanceAppsToAdd TC
	
	END
		
/*-------------------- Finnace App Ends ----------------------------*/

END


IF @Message IS NULL BEGIN
	set @Message ='Syncing Fleet Transactions Successful.'
	SELECT @Message
END


COMMIT TRAN

IF OBJECT_ID('tempdb..#temp_table_LinkedTransactions') IS NOT NULL
    DROP TABLE #temp_table_LinkedTransactions

END